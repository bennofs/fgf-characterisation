\documentclass[aspectratio=169]{beamer}

\usetheme{auriga}
\input{settings/packages.tex}
\usepackage{appendixnumberbeamer}

%\includeonlyframes{current}

\lstset{upquote=true}
%\setsansfont[BoldFont={Fira Sans SemiBold}]{Fira Sans Book}
\makeatletter
\newlength\beamerleftmargin
\setlength\beamerleftmargin{\Gm@lmargin}
\makeatother

\hypersetup{bookmarks=true,colorlinks=true,allcolors=blue}

\title{\textcolor{tolhighcontrastBlue}{A Constructive Proof of a Van~Benthem Theorem for the Forward Guarded Fragment of First~Order~Logic}}
\author{Benno Fünfstück}
\institute{\textcolor{toldarkDarkcyan}{Master's defense}}
\date{24.06.2024}

\include{tolcolors.tex}
\input{macros.tex}
\input{beamermacros.tex}

\newcommand*\makeAlph[1]{\symbol{\numexpr`a-1+#1}}
\setbeamerfont{page number in head/foot}{size=\large}
\setbeamertemplate{footline}{
    \hfill%
    \usebeamercolor[fg]{page number in head/foot}%
    \usebeamerfont{page number in head/foot}%
    \hspace{2em}%
    \insertframenumber\hbox to 1.5em{\smash{\small\makeAlph{\insertoverlaynumber}}\hfill}\vskip2ex%
}

\begin{document}

\begin{frame}[noframenumbering,plain]
  \titlepage
\end{frame}

\def\dragon{\textcolor{toldarkDarkyellow}{\mathrm{dragon}}}
\def\red{\textcolor{tolhighcontrastRed}{\mathrm{red}}}
\def\blue{\textcolor{tolhighcontrastBlue}{\mathrm{blue}}}
\def\green{\textcolor{tolbrightGreen}{\mathrm{green}}}
\def\fly{\textcolor{tolmutedCyan}{\mathrm{fly}}}
\def\band{\textcolor{black}{\mathrm{band}}}
\def\child{\mathit{child}}
\def\grandchild{\mathit{grandchild}}
\def\parent{\mathit{parent}}
\def\singer{\textcolor{tolhighcontrastBlue}{\mathrm{singer}}}
\def\plays{\mathit{plays}}
\def\drums{\textcolor{tolbrightGreen}{\mathrm{drums}}}
\def\trio{\textcolor{black}{\mathbf{trio}}}
\def\cross{\tikz[baseline, tolhighcontrastRed, yshift=0.6ex, very thick] \draw (45:1ex) -- (45:-1ex) (-45:1ex) -- (-45:-1ex);}
\def\check{\tikz[baseline, tolbrightGreenDarker, yshift=0.6ex, very thick, rounded corners=1pt] \draw (80:1ex) -- ++(80:-2ex) -- ++(160:1ex);}
\newcommand<>{\uncoverubrace}[2]{%
  \onslide#3 \underbrace{ \onslide<1->%
  #1%
  \onslide#3 }_{\mathclap{#2}} \onslide<1->%
}
% \begin{frame}\frametitle{First-order logic ($\FO$)}
%   \begin{center}
%     \Large
%     $\exists{x_{1}} (\dragon(x_{1}) \land \forall{x_{2}} (\child(x_{1}, x_{2}) \to \green(x_{2})))$ \\
%     ``there exists a dragon which has only green children''

%     \vspace{3ex}
%     \huge
%     \textbf{problem} \\[1ex]
%     \Large
%     many logical decision problems undecidable over $\FO$
%   \end{center}
% \end{frame}

\begin{frame}\frametitle{The forward guarded fragment ($\FGF$)}
  \vspace{3ex}
  \small
  ``there is a trio where the first member is a singer and the third member only plays drums''
  \large
  \begin{equation*}
    \exists{\alert<3>{x_{1}x_{2}x_{3}}}\;[
    \uncoverubrace<4>{\trio(\alert<2>{x_{1}, x_{2}, x_{3}})}{\text{\bfseries guard}} \land
    \uncoverubrace<4>{
      \singer(\alert<2,4>{x_{1}})
      \land \forall{\alert<3>{x_{4}}} \smash{(
      \uncoverubrace<5>{
        \plays(\alert<2>{\alert<4>{x_{3}}, x_{4}})
      }{\text{\bfseries guard}}
      \to \uncoverubrace<5>{\drums(\alert<2>{x_{4}})}{\text{\bfseries free variables $x_{4}$}}
      )}
    }{\text{\bfseries free variables $x_{1}, x_{3}$}}
    ]
  \end{equation*}

  \onslide<4->
  \normalsize
  \begin{center}
    \textbf{guarded quantification:} ``$\exists{\vartuplex}\; (\relR(\vartupley) \land \cdots)$'' and ``$\forall{\vartuplex}\; (\relR(\vartupley) \to \cdots)$''\\[1ex]
    \small
    ($\vartupley$ covers $\vartuplex$ and all free variables)
  \end{center}
\end{frame}

\begin{frame}\frametitle<1>{Van Benthem's theorem}\frametitle<2->{Van Benthem's theorem \smash{(finitary version)}}
  \begin{theorem}[Van Benthem's theorem for $\FGF$]
    \begin{overprint}
      \onslide<1>
      A first-order formula $\varphi$ is equivalent to some $\FGF$-formula if and only if it is invariant under $\FGF$-bisimulation.
      \onslide<2>
      A first-order formula $\varphi$ is equivalent to some $\FGF$-formula \textbf{over finite structures} if and only if it is invariant under $\FGF$-bisimulation \textbf{over finite structures}.
    \end{overprint}
  \end{theorem}

  \vspace{2ex}
  \begin{center}
    \input{res/bisim1.tex}
  \end{center}
  % \onslide<3>
  % \vspace{2em}
  % \begin{center}
  % $\varphi = \forall{x_{1}x_{2}}\; [(\green(x_{1}) \land \green(x_{2})) \to (\fly(x_{1}) \iff \fly(x_{2}))]$ \\[0.5ex]
  % $\varphi \equiv [\forall{x_{1}} (\green(x_{1}) \to \fly(x_{1}))] \lor [\forall{x_{1}} (\green(x_{1}) \to \neg \fly(x_{1}))]$
  % \end{center}
\end{frame}

{
\setbeamercolor{page number in head/foot}{fg=white}
\addtocounter{framenumber}{100}
\begin{frame}<-2>[label=outline]{Outline}%
  \begin{center}
  \begin{enumerate}
    \item<alert@2| check@3-> $\GF$-, $\FGF$- and $\ell$-bisimulation
    \item<alert@3| check@4-> Unraveling
    \item<alert@4| check@5> Proof of van Benthem for $\FGF$ %  \only<4->{
          % \uncover<5->{\\\textcolor{black}{\small
          % via Upgrading: $\FGF$-bisimulation invariance implies $\ell$-$\FGF$-bisimulation invariance \\
          % (Martin Otto has proved the same for $\GF$)}}}
  \end{enumerate}
  \end{center}

  % \onslide*<4->{
  % \uncover<5->{
  %   \begin{itemize}
  %     \item[]
  %           \begin{center}
  %             \input{res/upgrade-plan.tex}
  %           \end{center}
  %   \end{itemize}
  % }
  % }
\end{frame}
\addtocounter{framenumber}{-101}
}

% \begin{frame}{$\FGF$-bisimulation: forward partial map}
%   An $\FGF$-bisimulation is a set $\mathcal{Z}$ of \emph{forward partial maps} between two structures, satisfying \emph{back-and-forth conditions} (next slide)
%   \begin{center}
%     \input{res/forwardmap.tex}
%     \forwardmap{
%       nonforwardedges/.style = {
%         onslide=<3>{opacity=0.2},
%       },
%       tuples/.style = {
%         onslide=<1>{hidden, every path/.style=hidden},
%       },
%       caption/.style={
%         onslide=<-2>{hidden},
%       }
%     }
%   \end{center}
% \end{frame}

\begin{frame}{$\FGF$-bisimulation}
  \input{res/fgf-game}
\end{frame}

\begin{frame}{Bisimulation games}
  \textbf{Rules of the $\FGF$ bisimulation game}\\
  Invariant: selected tuples have the same forward type\\[2ex]
  In each round \begin{minipage}{0.8\textwidth}
  \begin{enumerate}
    \item Spoiler picks an infix of one of the selected tuples
    \item Spoiler extends this infix to a new live tuple
    \item Duplicator matches this move in the other structure
  \end{enumerate}
  \end{minipage}

  \vspace{3ex}
  \pause
  \textbf{Rules of the \alert{$\GF$} bisimulation game}\\
  Invariant: there is a \alert{partial isomorphism} between selected \alert{elements}\\[2ex]
  In each round \begin{minipage}{0.82\textwidth}
  \begin{enumerate}
    \item Spoiler picks \alert{a subset} of the selected elements in one structure
    \item Spoiler extends this set to a new \alert{guarded set}
    \item Duplicator matches this move in the other structure
  \end{enumerate}
  \end{minipage}
\end{frame}

\begin{frame}{$\ell$-bisimulation}
  The \textbf{quantifier rank} $\qr(\varphi)$ is the maximum nesting of blocks of quantifiers in $\varphi$.\\[2ex]

  \begin{example}[quantifier rank 2]
    \Large
    \begin{math}
      \varphi = \exists{x_{1}x_{2}} [\child(x_{1}, x_{2}) \land \forall{x_{3}} (\child(x_{2}, x_{3}) \to \singer(x_{3}))]
    \end{math}\\[1ex]

    \pause

    \begin{math}
      \psi = \exists{x_{1}x_{2}x_{3}}[\trio(x_{1},x_{2},x_{3})] \land \varphi
    \end{math}
  \end{example}

  \pause

  \vspace{3ex}
  \textbf{$\ell$-$\FGF$-bisimulation} ($\bisimto_{\FGF}^{\ell}$): Duplicator has a strategy to survive $\ell$ rounds. \\[1ex]
  If $\str{A} \bisimto_{\FGF}^{\ell} \str{B}$, then $\str{A}$ and $\str{B}$ satisfy the same $\FGF_{\ell}$ formulae \\
  (formulae with quantifier rank at most $\ell$).
\end{frame}

\begin{frame}
  \begin{center}
    \Huge
    {\usebeamercolor[fg]{block title}Lemma} \\[0.5ex]
    \Large
    If $\varphi$ is $\ell$-$\FGF$-bisimulation invariant, then $\varphi$ is logically equivalent to a formula in $\FGF_{\ell}$.
  \end{center}
\end{frame}

\begin{frame}{$\FGF_{\ell}$-invariance $\cong$ $\FGF$-expressible}
  \textbf{every $\bisimto_{\FGF_{\textcolor{tolhighcontrastRed}{\ell}}}$-invariant $\varphi$ is expressible in $\FGF$}:
  \vspace{0.5em}
  \begin{center}
  \input{res/finite-classes}
  \end{center}
  \begin{enumerate}
    \item The number of distinct $\FGF_{\ell}$ formulae is finite (up to logical equivalence).
    \item Each $\bisimto_{\FGF}^{\ell}$ equivalence class is characterized by some $\FGF_{\ell}$ formula.
    \item Let $\mathcal{C}$ be the set of charateristic formulae of those $\bisimto_{\FGF}^{\ell}$ equivalence classes in which $\varphi$ is satisfied.
    \item Now, $\varphi \equiv \bigvee C$.
  \end{enumerate}
\end{frame}

{
\setbeamercolor{page number in head/foot}{fg=white}
\addtocounter{framenumber}{100}
\againframe<3>{outline}
\addtocounter{framenumber}{-101}
}

\begin{frame}{Biseqs and Bipoints}
  \input{res/fgf-biseq}
\end{frame}

\begin{frame}{The forward unraveling $\smash{\unravel{A}}$}
  \input{res/forward-unravel}
\end{frame}

\begin{frame}{Properties of the unraveling}
  \begin{enumerate}
    \item $\elemtuples$ has the same forward type as $\elemtuplet$, then $\homop: s_{i} \mapsto t_{i}$ is a partial isomorphism
          \vspace{0.5em}

          \input{res/forward-map-to-partiso}
    \item<2> The intersection of a guarded set $\mathcal{S}$ and a tuple $\elemtupler$ is an infix
          \vspace{0.5em}

          \input{res/guarded-sets-infix}
  \end{enumerate}
\end{frame}

\begin{frame}
  \begin{center}
    \Huge
    {\usebeamercolor[fg]{block title}Lemma} \\[0.5ex]
    \huge
    $\unravel{A} \bisimto_{\GF}^{g} \unravel{B}\;$ given that $\;\str{A} \bisimto_{\FGF}^{\homop(g)} \str{B}$ \\[0.2ex]
    \normalsize
    (for some function $\homop$)
  \end{center}
\end{frame}

\def\tups{\textcolor{tolmutedTeal}{\elemtuples}}
\def\tupt{\textcolor{tolmutedTeal}{\elemtuplet}}
\def\ij#1{\textcolor{tolmutedWine}{(i_{#1},j_{#1})}}
\def\op#1{\textcolor{tolmutedWine}{(o_{#1},p_{#1})}}
\def\picelemOneA{%
  \tikz[baseline] {
    \tikzset{el/.style={draw, circle, minimum height=2.3ex, font=\small, inner sep=0.2ex, fill=white}};
    \node[el,anchor=base] {1};
  }%
}
\def\picelemOneB{%
  \tikz[baseline] {%
    \tikzset{el/.style={draw, circle, minimum height=2.3ex, font=\small, inner sep=0.2ex, fill=white}};
    \node[el,anchor=base] {a};
  }%
}
\def\picelemTwoA{%
  \tikz[baseline] {
    \tikzset{el/.style={draw, circle, minimum height=2.3ex, font=\small, inner sep=0.2ex, fill=white}};
    \node[el,anchor=base] {2};
  }%
}
\def\picelemTwoB{%
  \tikz[baseline] {
    \tikzset{el/.style={draw, circle, minimum height=2.3ex, font=\small, inner sep=0.2ex, fill=white}};
    \node[el,anchor=base] {b};
  }%
}
\def\ni{\textcolor{tolbrightYellowDarker}{i}}
\def\nj{\textcolor{tolbrightYellowDarker}{j}}
\def\tikzedge{
  \tikz[baseline=-0.5ex] \draw[-{Stealth[round]}] (0,0) -- (1em,0);
}
\begin{frame}{$z$-similarity}
  \begin{center}
    \input{res/zsim-square}
  \end{center}

  \onslide<3->
  \begin{minipage}[t]{0.6\textwidth}
    \begin{definition}[$z$-similar elements]
      \vspace{2.5ex}
      \picelemOneA{} $= \langle \cdots\; \tups_{0} \ij{1} \tups_{1} \ij{2} \cdots \ij{z} \tups_{z} / x \rangle$

      \vspace{2ex}
      \picelemOneB{} $= \langle \cdots\; \tupt_{0} \op{1} \tupt_{1} \op{2} \cdots \op{z} \tupt_{z} / y \rangle$
    \end{definition}
  \end{minipage}
  \begin{minipage}[t]{0.39\textwidth}
    \vspace{0.5ex}

    {\Large \picelemOneA{} $\approx_{z}$ \picelemOneB{} if, \normalsize for all $k \in [1,z]$}
    \vspace{0.5ex}
    {\large\begin{enumerate}
      \item $x = y$,
      \item $\ij{k} = \op{k}$, and
      \item $(\str{A}, \tups_{k}) \bisimto_{\FGF}^{z} (\str{B}, \tupt_{k})$.
    \end{enumerate}}
  \end{minipage}
\end{frame}

\begin{frame}{Upgrading to $\GF$ bisimulation}
  \input{res/z-sim}
\end{frame}

{
\setbeamercolor{page number in head/foot}{fg=white}
\addtocounter{framenumber}{100}
\againframe<4>{outline}
\addtocounter{framenumber}{-101}
}

\begin{frame}{Proving van Benthem}
  \textbf{Claim}: If $\varphi \in \FO$ is $\bisimto_{FGF}$-invariant, then it is expressible in $\FGF$.\\[3ex]

  \begin{minipage}[t]{0.5\framewidth}
    \textbf{Steps:}
    \vspace{1ex}
    \begin{enumerate}
      \itemsep1ex
      \item $\varphi$ is also $\bisimto_{\GF}$-invariant
      \item Martin Otto: $\varphi$ is $\bisimto_{\GF}^{g}$-invariant
      \item We show: $\varphi$ is $\bisimto_{\FGF}^{\homop(g)}$-invariant
    \end{enumerate}
    \vspace{1ex}
    {\usebeamercolor[fg]{item}(3)} implies that $\varphi$ is expressible in $\FGF$
  \end{minipage}
  \pause
  \input{res/upgrade-plan}
\end{frame}

\begin{frame}{Cutting to obtain a finite unraveling}
  \hspace{1em}\input{res/cutting}
\end{frame}

\begin{frame}{The finite forward unraveling $\smash{\unravel{A}_{\ell}}$}
  \input{res/finite-unraveling}
\end{frame}

% {
% \setbeamercolor{page number in head/foot}{fg=white}
% \againframe<5>[noframenumbering]{outline}
% }

{
\setbeamercolor{page number in head/foot}{fg=white}
\begin{frame}[noframenumbering]{Summary}
  \begin{center}
    \huge $\FGF \equiv \FO/{\bisimto_{\FGF}}$ \\[0.5ex]
    \large over finite structures
  \end{center}

  \begin{center}
    \pause
  \begin{minipage}[t]{0.4\textwidth}
    \raggedleft

    {\usebeamercolor[fg]{item} proof via new unraveling} \\
    \input{res/upgrade-summary.tex}
  \end{minipage}
  \hspace{4em}
  \pause
  \begin{minipage}[t]{0.4\textwidth}
    \raggedright

    {\usebeamercolor[fg]{item} bonus corollary} \\[1ex]

    \raggedleft
    \begin{minipage}{0.9\textwidth}
      \raggedright
      Decidability of checking whether a given $\GF$-formula is expressible in $\FGF$.
    \end{minipage}
  \end{minipage}
\end{center}
\end{frame}
}

\appendix

\begin{frame}{$z$-similarity: forward extension}
  \begin{center}
  given $\;\picelemOneA{} \approx_{z} \picelemOneB{}\;$ with
  \begin{math}
    \begin{array}{l @{{}={}\langle{}} c @{{}/{}} c @{{}\rangle}}
      \picelemOneA{} & \cdots \tups_{z-1} \ij{z} \tups_{z} & x \\[1ex]
      \picelemOneB{} & \cdots \tupt_{z-1} \op{z} \tupt_{z} & y
    \end{array}
  \end{math}

  \vspace{3em}
  \begin{minipage}{0.8\textwidth}
  \begin{minipage}{4em}
    \textbf{Case 1}\\{}
  \end{minipage}
  \begin{math}
    \begin{array}{rl @{{}={}\langle{}} c @{{}/{}} c @{{}\rangle}}
      \text{if} & \picelemTwoA{} & \cdots \tups_{z-1}\ij{z} \tups_{z} & x + 1 \\[1ex]
      \text{then} & \picelemTwoB{} & \cdots \tupt_{z-1}\op{z} \tupt_{z} & y + 1
    \end{array}
  \end{math}

  \vspace{2em}
  \begin{minipage}{4em}
    \textbf{Case 2}\\{}
  \end{minipage}
  \begin{math}
    \begin{array}{rl @{{}={}\langle{}} c @{{}/{}} c @{{}\rangle}}
      \text{if} & \picelemTwoA{} & \cdots \tups_{z} (\ni,\nj) \tups_{z+1} & (\nj{-}\ni{+}1) + 1 \\[1ex]
      \text{then} & \picelemTwoB{} & \cdots \tupt_{z} (\ni,\nj) \tupt_{z+1} & (\nj{-}\ni{+}1) + 1
    \end{array}
  \end{math}
  \end{minipage}
  \end{center}
\end{frame}

\begin{frame}{$z$-similarity: backward extension}
  \begin{center}
  given $\;\picelemTwoA{} \approx_{z} \picelemTwoB{}\;$ with
  \begin{math}
    \begin{array}{l @{{}={}\langle{}} c @{{}/{}} c @{{}\rangle}}
      \picelemTwoA{} & \cdots \tups_{z-1} \ij{z} \tups_{z} & x \\[1ex]
      \picelemTwoB{} & \cdots \tupt_{z-1} \op{z} \tupt_{z} & y
    \end{array}
  \end{math}

  \vspace{3em}
  \begin{minipage}{0.8\textwidth}
  \begin{minipage}{4em}
    \textbf{Case 1}\\{}
  \end{minipage}
  \begin{math}
    \begin{array}{rl @{{}={}\langle{}} c @{{}/{}} c @{{}\rangle}}
      \text{if} & \picelemOneA{} & \cdots \tups_{z-1}\ij{z} \tups_{z} & x - 1 \\[1ex]
      \text{then} & \picelemOneB{} & \cdots \tupt_{z-1}\op{z} \tupt_{z} & y - 1
    \end{array}
  \end{math}

  \vspace{2em}
  \begin{minipage}{4em}
    \textbf{Case 2}\\{}
  \end{minipage}
  \begin{math}
    \begin{array}{rl @{{}={}\langle{}} c @{{}/{}} c @{{}\rangle}}
      \text{if} & \picelemOneA{} & \cdots \tups_{z-1} & j_{z} \\[1ex]
      \text{then} & \picelemOneB{} & \cdots \tupt_{z-1} & p_{z}
    \end{array}
  \end{math}
  \end{minipage}
  \end{center}
\end{frame}


% \begin{frame}{Tree unraveling}
%   \begin{center}
%     \input{res/tree-simple}
%   \end{center}
% \end{frame}


\begin{frame}{Higher-arity relations: HAF unraveling}
  \input{res/ex-other-unravel-hat}
  \input{res/ex-other-unravel-struct}

  \begin{columns}
    \begin{column}{0.2\textwidth}
      \begin{overprint}
        \onslide<1>

        \onslide<2-3>
        \exunravelstruct{reledges/.style={hidden}, gaifman/.style={}}

        \onslide<4>
        \exunravelstruct{gaifman/.style={}}
      \end{overprint}
    \end{column}
    \begin{column}{0.75\textwidth}
      \begin{overprint}
        \onslide<1-2>
        \exunravelstruct{}

        \onslide<3>
        \exunravelhat{reledges/.style={hidden}}

        \onslide<4>
        \exunravelhat{}
      \end{overprint}
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}{HAF-unraveling does not upgrade to $\GF$}
  \input{res/hat-not-gf-unravel}
\end{frame}

% \begin{frame}
%   \frametitle{$\GF$-bisimulation: back-and-forth}
%   \begin{center}
%     \input{res/gfbackandforth.tex}
%     \gfbackandforth{ante}
%     \pause\vfill
%     \gfbackandforth{conseq}
%     \begin{tikzpicture}[remember picture,overlay]
%       \node[yshift=-2.5em, xshift=-1em, rotate=-90, font=\LARGE\bfseries] (implies) at (current page.center) { $\implies$ };
%       \node[right=0.5em of implies.center] { (forth) };
%     \end{tikzpicture}
%   \end{center}
% \end{frame}

% \begin{frame}{$\GF$-bisimulation: example}
%   \begin{center}
%     \input{res/gf-bisim-example}
%   \end{center}
% \end{frame}

% \begin{frame}{$\FGF$-bisimulation: back and forth}
%   \input{res/fgfbackandforth}
%   \begin{center}
%     \fgfbackandforth{
%       conseq/.style={hidden, overlay},
%       tupler/.style={uncover=<3->},
%       infix/.style={uncover=<2>}
%     }
%   \uncover<4->{
%   \vfill
%   \fgfbackandforth{ante/.style={hidden, overlay}}
%   \begin{tikzpicture}[remember picture,overlay]
%     \node[xshift=-1em, rotate=-90, font=\LARGE\bfseries] (implies) at (current page.center) { $\implies$ };
%     \node[right=0.5em of implies.center] { (forth) };
%   \end{tikzpicture}
%   }
%   \end{center}
% \end{frame}

% \begin{frame}{$\FGF$-bisimulation: example}
%   \begin{center}
%     \input{res/fgf-bisim-simple}
%   \end{center}
% \end{frame}

% \begin{frame}{$\GF$-bisimulation: partial isomorphism}
%   A $\GF$-bisimulation is a set $\mathcal{Z}$ of \emph{partial isomorphisms} between two structures, satisfying \emph{back-and-forth conditions} (next slide)
%   \vfill
%   \begin{center}
%   \input{res/partiso.tex}
%   \end{center}
% \end{frame}

\end{document}
