% -*- TeX-engine: xetex -*-
\documentclass[draft]{scrartcl}

\usepackage{ifxetex}
\usepackage{amsmath}

\ifxetex
  \usepackage{polyglossia}
  \usepackage{fontspec}

  \setmainlanguage{english}
\else
  \usepackage[english]{babel}
\fi

\usepackage{blindtext}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{hyperref}
\usepackage[capitalise]{cleveref}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{tabularx}
\usepackage{makecell}
\usepackage{placeins}
\usepackage{listings}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{fixme}
\usepackage{graphicx}
\usepackage[shortlabels]{enumitem}
\usepackage{pbox}
\usepackage{mathtools}

\setkeys{Gin}{draft=false} %load images in draft mode
\fxsetup{theme=color,status=draft}

\title{FGF Notes}
\author{Benno Fünfstück}
\date{March 2022}

\newtheorem{theorem}{Theorem}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{example}[theorem]{Example}
\newtheorem{observation}[theorem]{Observation}
\crefname{lemma}{Lemma}{Lemmas}
\crefname{definition}{Definition}{Definitions}
\crefname{theorem}{Theorem}{Theorems}
\crefname{observation}{Observation}{Observations}

\newcommand{\first}[1]{\mathtt{first}(#1)}
\newcommand{\last}[1]{\mathtt{last}(#1)}
\newcommand{\trace}[1]{\mathtt{trace}(#1)}
\newcommand{\context}[1]{\mathtt{context}(#1)}
\newcommand{\struct}[1]{\mathfrak{#1}}
\newcommand{\seq}[1]{\mathtt{Seq}_{#1}}
\newcommand{\dom}[1]{\mathtt{dom}({#1})}

\include{tolcolors}
\usetikzlibrary{calc}
\usetikzlibrary{backgrounds}
\usetikzlibrary{arrows}
\usetikzlibrary{arrows.meta}

\typeout{CONTENT START NOW}

\begin{document}

\maketitle

\section{Logics}

% exactly as in jair-main
\begin{definition}[Forward (Guarded) Fragment]
Let FF$(n)$ be the smallest fragment of FO satisfying:

\begin{itemize}
    \item an atom $\alpha(\bar{x})$ belongs to FF$(n)$ iff $\alpha$ is equality-free and $\bar{x}$ is an infix of $\bar{x}_{1\ldots{}n}$
    \item FF$(n)$ is closed under boolean connectives $\land, \lor, \neg, \rightarrow, \leftrightarrow$.
    \item If $\phi(\bar{x}_{1\ldots{}n+1}$ is in FF$(n+1)$, then $\exists{x_{n+1}}\phi(\bar{x}_{1\ldots{}n+1})$ and $\forall{x_{n+1}}\phi(\bar{x}_{1\ldots{}n+1})$ are in FF$(n)$.
\end{itemize}

The \emph{forward fragment} FF is the set FF$(0)$.
The \emph{forward guarded fragment} FGF is the \fxfatal*{Allow variable reuse}{intersection of FF with GF}.
\end{definition}

% as in jair-main.pdf
\begin{definition}[Forward type]
A $(\sigma,n)$-forward type is a maximally consistent conjunction of atoms of the form $\pm{}R(\bar{x}_{i\ldots{}i+ar(R)-1}$ for an index $1 \leq i \leq n - ar(R) + 1$.
\end{definition}

We denote by $\mathrm{ftp}_\mathfrak{A}(\bar{a})$ the unique $(\sigma,|\bar{a}|)$-forward type such that $\mathfrak{A} \models \mathrm{ftp}_\mathfrak{A}(\bar{a})$

\section{Back-and-forth conditions / Bisimulations / Games}

% adapted from Otto 2004
\begin{definition}[Connected GF back-and-forth conditions]
Let $\mathfrak{A}$ and $\mathfrak{B}$ be $\sigma$-structures, $\mathcal{Z}, \mathcal{Z'} \subseteq \mathtt{Part}(\mathfrak{A}, \mathfrak{B})$ sets of partial isomorphisms between $\mathfrak{A}$ and $\mathfrak{B}$.

$\mathcal{Z'}$ satisfies the connected GF back-and-forth conditions for $\mathcal{Z}$ if for every $p \in \mathcal{Z}$ the following holds:

\begin{description}
    \item[(gforth)] For any guarded subset $s'$ of $A$ with $s' \cap \mathtt{dom}(p)$ nonempty, there is some $p' \in \mathcal{Z}$ with $\mathtt{dom}(p') = s'$ such that $p$ and $p'$ agree on their common domain.
    \item[(gback)] For any guarded subset $t'$ of $B$ with $t' \cap \mathtt{im}(p)$ nonempty, there is some $p' \in \mathcal{Z}$ with $\mathtt{im}(p') = t'$ such that $p^{-1}$ and $p'^{-1}$ agree on their common domain.
\end{description}
\end{definition}

% adapted from jair-main.pdf
\begin{definition}[Connected FGF back-and-forth conditions]
Let $\mathfrak{A}$ and $\mathfrak{B}$ be $\sigma$-structures, $\mathcal{Z}, \mathcal{Z'} \subseteq \bigcup_{i=0}(A^i \times B^i)$ be mappings such that for any $(\bar{a}, \bar{b}) \in \mathcal{Z} \cup \mathcal{Z'}$ forward types are preserved: $\mathrm{ftp}_\mathfrak{A}(\bar{a}) = \mathrm{ftp}_\mathfrak{B}(\bar{b})$ (\textbf{atomic harmony}).

$\mathcal{Z'}$ satisfies the connected FGF back-and-forth conditions for $\mathcal{Z}$ if for every $(\bar{a}, \bar{b}) \in \mathcal{Z}$ the following conditions hold:

\begin{description}
    \item[(fgforth)] For a nonempty affix $\bar{a}_{i\ldots{}j}$ of $\bar{a}$ and a $\sigma$-live tuple $\bar{c}$ with $|c| \leq k$ in $\mathfrak{A}$ such that $\bar{a}_{i\ldots{}j} = \bar{c}_{1\ldots{}j-i+1}$ there is a tuple $\bar{d}$ with $\bar{b}_{i\ldots{}j} = \bar{d}_{1\ldots{}j-i+1}$ and $(\bar{c}, \bar{d}) \in \mathcal{Z'}$
    \item[(fgback)] For a nonempty affix $\bar{b}_{i\ldots{}j}$ of $\bar{b}$ and a $\sigma$-live tuple $\bar{d}$ with $|d| \leq k$ in $\mathfrak{B}$ such that $\bar{b}_{i\ldots{}j} = \bar{d}_{1\ldots{}j-i+1}$ there is a tuple $\bar{c}$ with $\bar{a}_{i\ldots{}j} = \bar{c}_{1\ldots{}j-i+1}$ and $(\bar{c}, \bar{d}) \in \mathcal{Z'}$
\end{description}
\end{definition}

\begin{definition}[Connected Bisimulation]
A set $\mathcal{Z}$ is a connected GF or FGF bisimulation between pointed $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$ if it satisfies the connected GF respective FGF back-and-forth conditions for itself and $(\bar{a}, \bar{b}) \in \mathcal{Z}$.
\end{definition}

We write $\mathfrak{A}, \bar{a} \sim_{\textrm{GF}} \mathfrak{B}, \bar{b}$ or $\mathfrak{A}, \bar{a} \sim_{\textrm{FGF}} \mathfrak{B}, \bar{b}$ if there exists a connected GF respective FGF bisimulation between pointed $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$.

\begin{definition}[k-Level Bisimulation]
A k-level bisimulation is a sequence of sets $\mathcal{Z}_0, \ldots, \mathcal{Z}_k$ such that each $\mathcal{Z}_{i - 1}$ for $0 < i \le k$ satisfies the associated back-and-forth conditions for $\mathcal{Z}_i$.
\end{definition}

We write $\mathfrak{A}, \bar{a} \sim_{\textrm{GF}, k} \mathfrak{B}, \bar{b}$ or $\mathfrak{A}, \bar{a} \sim_{\textrm{FGF}, k} \mathfrak{B}, \bar{b}$ if there exists a k-level connected GF respective FGF bisimulation between pointed $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$.

\begin{definition}[Global Bisimulation]
A global bisimulation between $\sigma$-structures $\mathfrak{A}$ and $\mathfrak{B}$ is a set $\mathcal{Z}$ such that for any guarded tuple $\bar{a} \in \mathfrak{A}$ there is a guarded tuple $\bar{b} \in \mathfrak{B}$ such that $(\bar{a}, \bar{b}) \in \mathcal{Z}$ and vice versa.
\end{definition}

\pagebreak

\section{Tree unraveling}

\subsection{Infinite full tree unraveling}

\begin{definition}[Bisimulation Sequences]
  The set of bisimulation sequences $\seq{\struct{A}}$ for a structure $\struct{A}$ consists of all sequences of the form $\bar{a}_{0}(i_{1}, j_{1})\bar{a}_{1}\cdots{}(i_{l},j_{l})\bar{a}_{l}$, where:
  \begin{enumerate}[(1)]
    \item $a_{i}$ is a live tuple in $\struct{A}$ for every $0 \le i \le l$,
    \item for every $1 \le k \le l$, $(i_{k}, j_{k})$ is a pair of indices into $\bar{a}_{k-1}$ such that $\bar{a}_{k-1,i\ldots{}j} = \bar{a}_{k,1\ldots{j-i+1}}$,
    \item $j_{k}-i_{k}+1 < |a_{k}|$ for $1 \le k \le l$, and
    \item $j_{k} > j_{k-1}-i_{k-1} + 1$ for $2 \le k \le n$
  \end{enumerate}
  This set is partially ordered with $s_{1} \le s_{2}$ iff $s_{1}$ is a prefix of $s_{2}$ for two sequences $s_{1}, s_{2}$.
\end{definition}

\begin{definition}[Unraveling Domain]
  The unraveling domain $\mathtt{Dom}^{\rightarrow}_{\struct{A}}$ of a structure $\struct{A}$ is defined as:

  \begin{equation*}
    \mathtt{Dom}^{\rightarrow}_{\struct{A}}
      = (\seq{\struct{A}} \times \mathbb{N})
        \setminus
        \left\{ (s(i,j)\bar{a}, k) \mid k \le i-j+1\ \text{or}\ k > |a| \right\}
  \end{equation*}
  The successor relation ``$\rightarrow$'' is the smallest binary relation defined on the unraveling domain such that:
  \begin{enumerate}[(a)]
    \item $(s, k) \rightarrow (s, k + 1)$
    \item $(s, j) \rightarrow (s(i,j)\bar{a}, j - k + 2)$
  \end{enumerate}
\end{definition}

\subsection{Finite tree-like unraveling}

\fxnote{todo}


\end{document}

% additional elements
