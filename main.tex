% -*- TeX-engine: xetex -*-
\documentclass[draft]{scrartcl}

\usepackage{ifxetex}
\usepackage{amsmath}

\ifxetex
  \usepackage{polyglossia}
  \usepackage{fontspec}

  \setmainlanguage{english}
\else
  \usepackage[english]{babel}
\fi

\usepackage{blindtext}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{hyperref}
\usepackage[capitalise]{cleveref}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{tabularx}
\usepackage{makecell}
\usepackage{placeins}
\usepackage{listings}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{fixme}
\usepackage{graphicx}
\usepackage[shortlabels]{enumitem}
\usepackage{pbox}
\usepackage{mathtools}

\setkeys{Gin}{draft=false} %load images in draft mode
\fxsetup{theme=color,status=draft}

\title{FGF Notes}
\author{Benno Fünfstück}
\date{March 2022}

\newtheorem{theorem}{Theorem}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{example}[theorem]{Example}
\newtheorem{observation}[theorem]{Observation}
\crefname{lemma}{Lemma}{Lemmas}
\crefname{definition}{Definition}{Definitions}
\crefname{theorem}{Theorem}{Theorems}
\crefname{observation}{Observation}{Observations}

\newcommand{\first}[1]{\mathtt{first}(#1)}
\newcommand{\last}[1]{\mathtt{last}(#1)}
\newcommand{\trace}[1]{\mathtt{trace}(#1)}
\newcommand{\context}[1]{\mathtt{context}(#1)}
\newcommand{\struct}[1]{\mathfrak{#1}}
\newcommand{\seq}[1]{\mathtt{Seq}_{#1}}
\newcommand{\dom}[1]{\mathtt{dom}({#1})}
\newcommand{\dist}[2]{\mathtt{dist}({#1},{#2})}
\newcommand{\nextrel}[2]{\mathit{Next}({#1},{#2})}
\newcommand{\lift}[1]{\mathtt{lift}({#1})}

\include{tolcolors}
\usetikzlibrary{calc}
\usetikzlibrary{backgrounds}
\usetikzlibrary{arrows}
\usetikzlibrary{arrows.meta}

\typeout{CONTENT START NOW}

\begin{document}

\maketitle

\section{Logics}

% exactly as in jair-main
\begin{definition}[Forward (Guarded) Fragment]
Let FF$(n)$ be the smallest fragment of FO satisfying:

\begin{itemize}
    \item an atom $\alpha(\bar{x})$ belongs to FF$(n)$ iff $\alpha$ is equality-free and $\bar{x}$ is an infix of $\bar{x}_{1\ldots{}n}$
    \item FF$(n)$ is closed under boolean connectives $\land, \lor, \neg, \rightarrow, \leftrightarrow$.
    \item If $\phi(\bar{x}_{1\ldots{}n+1}$ is in FF$(n+1)$, then $\exists{x_{n+1}}\phi(\bar{x}_{1\ldots{}n+1})$ and $\forall{x_{n+1}}\phi(\bar{x}_{1\ldots{}n+1})$ are in FF$(n)$.
\end{itemize}

The \emph{forward fragment} FF is the set FF$(0)$.
The \emph{forward guarded fragment} FGF is the \fxfatal*{Allow variable reuse}{intersection of FF with GF}.
\end{definition}

% as in jair-main.pdf
\begin{definition}[Forward type]
A $(\sigma,n)$-forward type is a maximally consistent conjunction of atoms of the form $\pm{}R(\bar{x}_{i\ldots{}i+ar(R)-1}$ for an index $1 \leq i \leq n - ar(R) + 1$.
\end{definition}

We denote by $\mathrm{ftp}_\mathfrak{A}(\bar{a})$ the unique $(\sigma,|\bar{a}|)$-forward type such that $\mathfrak{A} \models \mathrm{ftp}_\mathfrak{A}(\bar{a})$

\section{Back-and-forth conditions / Bisimulations / Games}

% adapted from Otto 2004
\begin{definition}[Connected GF back-and-forth conditions]
Let $\mathfrak{A}$ and $\mathfrak{B}$ be $\sigma$-structures, $\mathcal{Z}, \mathcal{Z'} \subseteq \mathtt{Part}(\mathfrak{A}, \mathfrak{B})$ sets of partial isomorphisms between $\mathfrak{A}$ and $\mathfrak{B}$.

$\mathcal{Z'}$ satisfies the connected GF back-and-forth conditions for $\mathcal{Z}$ if for every $p \in \mathcal{Z}$ the following holds:

\begin{description}
    \item[(gforth)] For any guarded subset $s'$ of $A$ with $s' \cap \mathtt{dom}(p)$ nonempty, there is some $p' \in \mathcal{Z}$ with $\mathtt{dom}(p') = s'$ such that $p$ and $p'$ agree on their common domain.
    \item[(gback)] For any guarded subset $t'$ of $B$ with $t' \cap \mathtt{im}(p)$ nonempty, there is some $p' \in \mathcal{Z}$ with $\mathtt{im}(p') = t'$ such that $p^{-1}$ and $p'^{-1}$ agree on their common domain.
\end{description}
\end{definition}

% adapted from jair-main.pdf
\begin{definition}[Connected FGF back-and-forth conditions]
Let $\mathfrak{A}$ and $\mathfrak{B}$ be $\sigma$-structures, $\mathcal{Z}, \mathcal{Z'} \subseteq \bigcup_{i=0}(A^i \times B^i)$ be mappings such that for any $(\bar{a}, \bar{b}) \in \mathcal{Z} \cup \mathcal{Z'}$ forward types are preserved: $\mathrm{ftp}_\mathfrak{A}(\bar{a}) = \mathrm{ftp}_\mathfrak{B}(\bar{b})$ (\textbf{atomic harmony}).

$\mathcal{Z'}$ satisfies the connected FGF back-and-forth conditions for $\mathcal{Z}$ if for every $(\bar{a}, \bar{b}) \in \mathcal{Z}$ the following conditions hold:

\begin{description}
    \item[(fgforth)] For a nonempty affix $\bar{a}_{i\ldots{}j}$ of $\bar{a}$ and a $\sigma$-live tuple $\bar{c}$ with $|c| \leq k$ in $\mathfrak{A}$ such that $\bar{a}_{i\ldots{}j} = \bar{c}_{1\ldots{}j-i+1}$ there is a tuple $\bar{d}$ with $\bar{b}_{i\ldots{}j} = \bar{d}_{1\ldots{}j-i+1}$ and $(\bar{c}, \bar{d}) \in \mathcal{Z'}$
    \item[(fgback)] For a nonempty affix $\bar{b}_{i\ldots{}j}$ of $\bar{b}$ and a $\sigma$-live tuple $\bar{d}$ with $|d| \leq k$ in $\mathfrak{B}$ such that $\bar{b}_{i\ldots{}j} = \bar{d}_{1\ldots{}j-i+1}$ there is a tuple $\bar{c}$ with $\bar{a}_{i\ldots{}j} = \bar{c}_{1\ldots{}j-i+1}$ and $(\bar{c}, \bar{d}) \in \mathcal{Z'}$
\end{description}
\end{definition}

\begin{definition}[Connected Bisimulation]
A set $\mathcal{Z}$ is a connected GF or FGF bisimulation between pointed $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$ if it satisfies the connected GF respective FGF back-and-forth conditions for itself and $(\bar{a}, \bar{b}) \in \mathcal{Z}$.
\end{definition}

We write $\mathfrak{A}, \bar{a} \sim_{\textrm{GF}} \mathfrak{B}, \bar{b}$ or $\mathfrak{A}, \bar{a} \sim_{\textrm{FGF}} \mathfrak{B}, \bar{b}$ if there exists a connected GF respective FGF bisimulation between pointed $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$.

\begin{definition}[k-Level Bisimulation]
A k-level bisimulation is a sequence of sets $\mathcal{Z}_0, \ldots, \mathcal{Z}_k$ such that each $\mathcal{Z}_{i - 1}$ for $0 < i \le k$ satisfies the associated back-and-forth conditions for $\mathcal{Z}_i$.
\end{definition}

We write $\mathfrak{A}, \bar{a} \sim_{\textrm{GF}, k} \mathfrak{B}, \bar{b}$ or $\mathfrak{A}, \bar{a} \sim_{\textrm{FGF}, k} \mathfrak{B}, \bar{b}$ if there exists a k-level connected GF respective FGF bisimulation between pointed $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$.

\begin{definition}[Global Bisimulation]
A global bisimulation between $\sigma$-structures $\mathfrak{A}$ and $\mathfrak{B}$ is a set $\mathcal{Z}$ such that for any guarded tuple $\bar{a} \in \mathfrak{A}$ there is a guarded tuple $\bar{b} \in \mathfrak{B}$ such that $(\bar{a}, \bar{b}) \in \mathcal{Z}$ and vice versa.
\end{definition}

\pagebreak

\section{Tree unraveling}

\subsection{Infinite full tree unraveling}

\begin{definition}[Bisimulation Sequences]
  The set of bisimulation sequences $\seq{\struct{A}}$ for a structure $\struct{A}$ consists of all sequences of the form $\bar{a}_{0}(i_{1}, j_{1})\bar{a}_{1}\cdots{}(i_{l},j_{l})\bar{a}_{l}$, where:
  \begin{enumerate}[(1)]
    \item $a_{i}$ is a live tuple in $\struct{A}$ for every $0 \le i \le l$,
    \item for every $1 \le k \le l$, $(i_{k}, j_{k})$ is a pair of indices into $\bar{a}_{k-1}$ such that $\bar{a}_{k-1,i_{k}\ldots{}j_{k}} = \bar{a}_{k,1\ldots{\dist{i_{k}}{j_{k}}}}$,
    \item $\dist{i_{k}}{j_{k}} < |a_{k}|$ for $1 \le k \le l$, and
    \item $j_{k} > \dist{i_{k-1}}{j_{k-1}}$ for $2 \le k \le n$
  \end{enumerate}
  This set is partially ordered with $\sigma_{1} \le \sigma_{2}$ iff $\sigma_{1}$ is a prefix of $\sigma_{2}$ for two sequences $s_{1}, s_{2}$.
\end{definition}

\begin{definition}[Unraveling Domain]
  The unraveling domain $\mathtt{Dom}^{\rightarrow}_{\struct{A}}$ of a structure $\struct{A}$ is defined as:

  \begin{equation*}
    \mathtt{Dom}^{\rightarrow}_{\struct{A}}
      = (\seq{\struct{A}} \times \mathbb{N})
        \setminus
        \left\{ (\sigma(i,j)\bar{a}, k) \mid k \le \dist{i}{j}\ \text{or}\ k > |a| \right\}
  \end{equation*}
  The successor relation ``$\mathit{Next}$'' is the smallest binary relation defined on the unraveling domain such that:
  \begin{enumerate}[(a)]
    \item $\nextrel{(\sigma, k)}{(\sigma, k + 1)}$
    \item $\nextrel{(\sigma, j)}{(\sigma(i,j)\bar{a}, \dist{i}{j} + 1)}$
  \end{enumerate}
  The projection ``$\pi$'' of a domain element $(\sigma, k)$ is defined as follows.
  Let $\bar{a}$ be the last tuple in the sequence $\sigma$, so $\sigma = \cdots{}\bar{a}$.
  Then $\pi((\sigma, k)) = \bar{a}_{k}$.
\end{definition}

\begin{definition}[Infinite Full Tree Unraveling]
  The infinite full tree unraveling for a base structure $\struct{A}$ is a structure $\struct{A}^{\rightarrow{}}$ with domain $\mathtt{Dom}^{\rightarrow}_{\struct{A}}$.
  Each relation $R_{i}$ in the signature of $\struct{A}$ is interpreted in $\struct{A}^{\rightarrow}$ as:
  \begin{equation*}
    \bar{r} \in R_{i}^{\struct{A}^{\rightarrow}} \iff \pi[\bar{r}] \in R_{i}^{\struct{A}} \land \bigwedge_{k=1}^{|\bar{r}|-1}{(\nextrel{r_{k}}{r_{k+1}})} \land |\bar{r}| \le \mathtt{bound}(\bar{r})
  \end{equation*}
  where $\mathtt{bound}(\bar{r}) = x$ such that $r_{|r|} = (\rho, x)$ for some bisimulation sequence $\rho$.
\end{definition}

\begin{definition}[Lifting tuples and bisimulation sequences]
  For each tuple $\bar{a} \in \struct{A}$, we define a lifted tuple $\lift{\bar{a}} \in \struct{A}^{\rightarrow}$ as follows:
  \begin{equation*}
    \lift{\bar{a}} = ((\bar{a}, 1), \ldots{}, (\bar{a}, |a|))
  \end{equation*}
  The mapping can be extended to bisimulation sequences.
  Let $\rho = \sigma(i,j)\bar{a}$ be a bisimulation sequence, then the $\lift{\rho}$ is defined such that:
  \begin{alignat*}{3}
    &{\lift{\rho}}_{1\ldots{}\dist{i}{j}} &&= {\lift{\sigma}}_{i\ldots{}j} && \\
    &{\lift{\rho}}_{x} &&= (\rho, x) && \qquad\text{for $\dist{i}{j} < x \le |\bar{a}|$}
  \end{alignat*}
\end{definition}

\begin{lemma}
  $\struct{A} \sim_{\mathrm{FGF}} \struct{A}^{\rightarrow{}}$
\end{lemma}
\begin{proof}
  We show that the set $\mathcal{Z}$, defined as follows, is FGF bisimulation:
  \begin{equation*}
    (\bar{a}, \bar{a}^{*}) \in \mathcal{Z} \iff
    \bar{a} = \pi[\bar{a}^{*}] \text{\ and\ }
    \bar{a}^{*} \text{\ is live}
  \end{equation*}

  \begin{description}
    \item[(atomic harmony)]
          Let $(\bar{a}, \bar{a}^{*}) \in \mathcal{Z}$.
          We show that $\bar{a}_{i\ldots{}j} \in R^{\struct{A}} \iff \bar{a}^{*}_{i\ldots{}j} \in R^{\struct{A}^{\rightarrow}}$.
          From $\bar{a} = \pi[\bar{a}^{*}]$ follows that $\bar{a}_{i\ldots{}j} = \pi[\bar{a}^{*}_{i\ldots{}j}]$.
          By definition of the unraveling $\bar{a}^{*}_{i\ldots{}j} \in R^{\struct{A}^{\rightarrow}}$ implies $\pi[\bar{a}^{*}_{i\ldots{}j}] \in R^{\struct{A}}$ leaving only the ``$\implies$'' direction to be shown.
          We prove the three conditions required for $\bar{a}^{*}_{i\ldots{}j} \in R^{\struct{A}^{\rightarrow}}$:
          \begin{itemize}
            \item
                  $\pi[\bar{a}^{*}_{i\ldots{}j}] \in R^{\mathfrak{A}}$ follows directly from $\bar{a}_{i\ldots{}j} \in R^{\mathfrak{A}}$.
            \item
                  $\bigwedge_{k=1}^{|\bar{a}^{*}_{i\ldots{}j}|-1}{(\nextrel{\bar{a}^{*}_{i\ldots{}j,k}}{{}\bar{a}^{*}_{i\ldots{}j,k+1}})}$ is true since $\bar{a}^{*}$ is live so $\nextrel{a^{*}_{k}}{a^{*}_{k+1}}$ for all $1 \le k < |\bar{a}^{*}|$.
            \item
                  To show that $|\bar{a}^{*}_{i\ldots{j}}| \le \mathtt{bound}(\bar{a}^{*}_{i\ldots{}j})$, let $\bar{a}^{*} = ((\sigma_{1}, x_{1}), \ldots{}, (\sigma_{n}, x_{n}))$.
                  We know that for all $1 \le k < |\bar{a}^{*}|$ we have $\nextrel{(\sigma_{k}, x_{k})}{(\sigma_{k}, x_{k+1})}$ since $\bar{a}^{*}$ is live.
                  This implies $x_{k} \ge x_{k+1} - 1$ as can be seen by analysing the two cases of the definition of $\mathit{Next}$.
                  Since $\bar{a}^{*}$ is live we have $\mathtt{bound}(\bar{a}^{*}) = x_{n} \ge n = |\bar{a}^{*}|$.
                  It follows that $x_{k} \ge k$ for all $k$, so $\mathtt{bound}(\bar{a}^{*}_{i\ldots{}j}) = x_{j} \ge j \ge |\bar{a}^{*}_{i\ldots{j}}|$ as required.
          \end{itemize}
  \end{description}

\end{proof}
\subsection{Finite tree-like unraveling}

\fxnote{todo}


\end{document}

% additional elements
