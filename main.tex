% -*- TeX-engine: xetex -*-
\documentclass[draft]{scrartcl}

\usepackage{ifxetex}
\usepackage{amsmath}

\ifxetex
  \usepackage{polyglossia}
  \usepackage{fontspec}

  \setmainlanguage{english}
\else
  \usepackage[english]{babel}
\fi

\usepackage{blindtext}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{hyperref}
\usepackage[capitalise]{cleveref}
\usepackage{booktabs}
\usepackage{tikz}
\usepackage{tabularx}
\usepackage{makecell}
\usepackage{placeins}
\usepackage{listings}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{fixme}
\usepackage{graphicx}
\usepackage[shortlabels]{enumitem}
\usepackage{pbox}
\usepackage{mathtools}

\setkeys{Gin}{draft=false} %load images in draft mode
\fxsetup{theme=color,status=draft}

\title{FGF Notes}
\author{Benno Fünfstück}
\date{\today}

\newtheorem{theorem}{Theorem}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{example}[theorem]{Example}
\newtheorem{observation}[theorem]{Observation}
\crefname{lemma}{Lemma}{Lemmas}
\crefname{definition}{Definition}{Definitions}
\crefname{theorem}{Theorem}{Theorems}
\crefname{observation}{Observation}{Observations}

\newcommand{\first}[1]{\mathtt{first}(#1)}
\newcommand{\last}[1]{\mathtt{last}(#1)}
\newcommand{\trace}[1]{\mathtt{trace}(#1)}
\newcommand{\context}[1]{\mathtt{context}(#1)}
\newcommand{\struct}[1]{\mathfrak{#1}}
\newcommand{\seqset}[1]{\mathtt{Seq}_{#1}}
\newcommand{\seq}[1]{\mathtt{seq}({#1})}
\newcommand{\num}[1]{\mathtt{num}({#1})}
\newcommand{\dom}[1]{\mathtt{dom}({#1})}
\newcommand{\dist}[2]{\mathtt{dist}({#1},{#2})}
\newcommand{\nextrel}[2]{\mathit{Next}({#1},{#2})}
\newcommand{\lift}[1]{\mathtt{lift}({#1})}
\newcommand{\sij}{_{i\ldots{}j}}

\include{tolcolors}
\usetikzlibrary{calc}
\usetikzlibrary{backgrounds}
\usetikzlibrary{arrows}
\usetikzlibrary{arrows.meta}

\typeout{CONTENT START NOW}

\begin{document}

\maketitle

\section{Logics}

% exactly as in jair-main
\begin{definition}[Forward (Guarded) Fragment]
Let FF$(n)$ be the smallest fragment of FO satisfying:

\begin{itemize}
    \item an atom $\alpha(\bar{x})$ belongs to FF$(n)$ iff $\alpha$ is equality-free and $\bar{x}$ is an infix of $\bar{x}_{1\ldots{}n}$
    \item FF$(n)$ is closed under boolean connectives $\land, \lor, \neg, \rightarrow, \leftrightarrow$.
    \item If $\phi(\bar{x}_{1\ldots{}n+1}$ is in FF$(n+1)$, then $\exists{x_{n+1}}\phi(\bar{x}_{1\ldots{}n+1})$ and $\forall{x_{n+1}}\phi(\bar{x}_{1\ldots{}n+1})$ are in FF$(n)$.
\end{itemize}

The \emph{forward fragment} FF is the set FF$(0)$.
The \emph{forward guarded fragment} FGF is the \fxfatal*{Allow variable reuse}{intersection of FF with GF}.
\end{definition}

% as in jair-main.pdf
\begin{definition}[Forward type]
A $(\sigma,n)$-forward type is a maximally consistent conjunction of atoms of the form $\pm{}R(\bar{x}_{i\ldots{}i+ar(R)-1}$ for an index $1 \leq i \leq n - ar(R) + 1$.
\end{definition}

We denote by $\mathrm{ftp}_\mathfrak{A}(\bar{a})$ the unique $(\sigma,|\bar{a}|)$-forward type such that $\mathfrak{A} \models \mathrm{ftp}_\mathfrak{A}(\bar{a})$

\section{Back-and-forth conditions / Bisimulations / Games}

% adapted from Otto 2004
\begin{definition}[GF back-and-forth conditions]
Let $\mathfrak{A}$ and $\mathfrak{B}$ be $\sigma$-structures, $\mathcal{Z}, \mathcal{Z'} \subseteq \mathtt{Part}(\mathfrak{A}, \mathfrak{B})$ sets of partial isomorphisms between $\mathfrak{A}$ and $\mathfrak{B}$.

$\mathcal{Z'}$ satisfies the GF back-and-forth conditions for $\mathcal{Z}$ if for every $p \in \mathcal{Z}$ the following holds:

\begin{description}
    \item[(gforth)] For any guarded subset $s'$ of $A$, there is some $p' \in \mathcal{Z}$ with $\mathtt{dom}(p') = s'$ such that $p$ and $p'$ agree on their common domain.
    \item[(gback)] For any guarded subset $t'$ of $B$, there is some $p' \in \mathcal{Z}$ with $\mathtt{im}(p') = t'$ such that $p^{-1}$ and $p'^{-1}$ agree on their common domain.
\end{description}
\end{definition}

% adapted from jair-main.pdf
\begin{definition}[FGF back-and-forth conditions]
Let $\mathfrak{A}$ and $\mathfrak{B}$ be $\sigma$-structures, $\mathcal{Z}, \mathcal{Z'} \subseteq \bigcup_{i=0}(A^i \times B^i)$ be mappings such that for any $(\bar{a}, \bar{b}) \in \mathcal{Z} \cup \mathcal{Z'}$ forward types are preserved: $\mathrm{ftp}_\mathfrak{A}(\bar{a}) = \mathrm{ftp}_\mathfrak{B}(\bar{b})$ (\textbf{atomic harmony}).

$\mathcal{Z'}$ satisfies the FGF back-and-forth conditions for $\mathcal{Z}$ if for every $(\bar{a}, \bar{b}) \in \mathcal{Z}$ the following conditions hold:

\begin{description}
    \item[(fgforth)] For an infix $\bar{a}_{i\ldots{}j}$ of $\bar{a}$ and a $\sigma$-live tuple $\bar{c}$ with $|c| \leq k$ in $\mathfrak{A}$ such that $\bar{a}_{i\ldots{}j} = \bar{c}_{1\ldots{}j-i+1}$ there is a tuple $\bar{d}$ with $\bar{b}_{i\ldots{}j} = \bar{d}_{1\ldots{}j-i+1}$ and $(\bar{c}, \bar{d}) \in \mathcal{Z'}$
    \item[(fgback)] For an infix $\bar{b}_{i\ldots{}j}$ of $\bar{b}$ and a $\sigma$-live tuple $\bar{d}$ with $|d| \leq k$ in $\mathfrak{B}$ such that $\bar{b}_{i\ldots{}j} = \bar{d}_{1\ldots{}j-i+1}$ there is a tuple $\bar{c}$ with $\bar{a}_{i\ldots{}j} = \bar{c}_{1\ldots{}j-i+1}$ and $(\bar{c}, \bar{d}) \in \mathcal{Z'}$
\end{description}
\end{definition}

\begin{definition}[Bisimulation]
A set $\mathcal{Z}$ is a GF or FGF bisimulation between $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$ if it satisfies the GF respective FGF back-and-forth conditions for itself and $(\bar{a}, \bar{b}) \in \mathcal{Z}$.
\end{definition}

We write $\mathfrak{A}, \bar{a} \sim_{\textrm{GF}} \mathfrak{B}, \bar{b}$ or $\mathfrak{A}, \bar{a} \sim_{\textrm{FGF}} \mathfrak{B}, \bar{b}$ if there exists a GF respective FGF bisimulation between $\sigma$-structures $\mathfrak{A}, \bar{a}$ and $\mathfrak{B}, \bar{b}$.

\begin{definition}[k-Level Bisimulation]
A k-level bisimulation is a sequence of sets $\mathcal{Z}_0, \ldots, \mathcal{Z}_k$ such that each $\mathcal{Z}_{i - 1}$ for $0 < i \le k$ satisfies the associated back-and-forth conditions for $\mathcal{Z}_i$.
\end{definition}

\pagebreak

\section{Tree unraveling}

\subsection{Infinite full tree unraveling}

\begin{definition}[Bisimulation Sequences]
  The set of bisimulation sequences $\seqset{\struct{A}}$ for a structure $\struct{A}$ consists of all sequences of the form $\bar{a}_{0}(i_{1}, j_{1})\bar{a}_{1}\cdots{}(i_{l},j_{l})\bar{a}_{l}$, where:
  \begin{enumerate}[(1)]
    \item $a_{i}$ is a live tuple in $\struct{A}$ for every $0 \le i \le l$,
    \item for every $1 \le k \le l$, $(i_{k}, j_{k})$ is a pair of indices into $\bar{a}_{k-1}$ such that $\bar{a}_{k-1,i_{k}\ldots{}j_{k}} = \bar{a}_{k,1\ldots{\dist{i_{k}}{j_{k}}}}$,
    \item $\dist{i_{k}}{j_{k}} < |a_{k}|$ for $1 \le k \le l$, and
    \item $j_{k} > \dist{i_{k-1}}{j_{k-1}}$ for $2 \le k \le n$
  \end{enumerate}
  This set is partially ordered with $\sigma_{1} \le \sigma_{2}$ iff $\sigma_{1}$ is a prefix of $\sigma_{2}$ for two sequences $s_{1}, s_{2}$.
\end{definition}

\begin{definition}[Unraveling Domain]
  The unraveling domain $\mathtt{Dom}^{\rightarrow}_{\struct{A}}$ of a structure $\struct{A}$ is defined as:
  \begin{equation*}
    \mathtt{Dom}^{\rightarrow}_{\struct{A}}
      = (\seqset{\struct{A}} \times \mathbb{N})
        \setminus
        \left\{ (\sigma(i,j)\bar{a}, k) \mid k \le \dist{i}{j}\ \text{or}\ k > |a| \right\}
  \end{equation*}
  Let ``$\mathit{Next}$'' be the binary relation such that $((\rho, k), (\rho', k')) \in \mathit{Next}$ iff:
  \begin{enumerate}[(a)]
    \item $\rho' = \rho$ and $k' = k + 1'$, or
    \item $\rho' = \rho (i,j) \bar{a}$ for some $i, j, \bar{a}$ and $k = j, k' = \dist{i}{j} + 1$
  \end{enumerate}
  Let $e = (\rho, k) \in \mathtt{Dom}^{\rightarrow}$ be a domain element and $\bar{a}$ be the tuple so that $\sigma = \cdots{}\bar{a}$.
  We will use the following notation:
  \begin{enumerate}
    \item $\pi(e) = \bar{a}_{k} \in A$ (the projection of $e$)
    \item $\seq{e} = \rho \in \seqset{\struct{A}}$ (the sequence of $e$)
    \item $\num{e} = k \in \mathbb{N}$ (the counter of $e$)
  \end{enumerate}
\end{definition}


\begin{definition}[Infinite Full Tree Unraveling]
  The infinite full tree unraveling for a base structure $\struct{A}$ is a structure $\struct{A}^{\rightarrow{}}$ with domain $\mathtt{Dom}^{\rightarrow}_{\struct{A}}$.
  Each relation $R_{i}$ in the signature of $\struct{A}$ is interpreted in $\struct{A}^{\rightarrow}$ as:
  \begin{equation*}
    \overrightarrow{r} \in R_{i}^{\struct{A}^{\rightarrow}} \iff \pi[\overrightarrow{r}] \in R_{i}^{\struct{A}} \land \bigwedge_{k=1}^{|\overrightarrow{r}|-1}{(\nextrel{\overrightarrow{r}_{k}}{\overrightarrow{r}_{k+1}})} \land |\overrightarrow{r}| \le \mathtt{bound}(\overrightarrow{r})
  \end{equation*}
  where $\mathtt{bound}(\overrightarrow{r}) = \num{\overrightarrow{r}_{|\overrightarrow{r}|}}$ (counter of last element of $\overrightarrow{r}$)
\end{definition}

% \begin{definition}[Lifting tuples and bisimulation sequences]
%   For each tuple $\bar{a} \in \struct{A}$, we define a lifted tuple $\lift{\bar{a}} \in \struct{A}^{\rightarrow}$ as follows:
%   \begin{equation*}
%     \lift{\bar{a}} = ((\bar{a}, 1), \ldots{}, (\bar{a}, |a|))
%   \end{equation*}
%   The mapping can be extended to bisimulation sequences.
%   Let $\rho = \sigma(i,j)\bar{a}$ be a bisimulation sequence, then the $\lift{\rho}$ is defined such that:
%   \begin{alignat*}{3}
%     &{\lift{\rho}}_{1\ldots{}\dist{i}{j}} &&= {\lift{\sigma}}_{i\ldots{}j} && \\
%     &{\lift{\rho}}_{x} &&= (\rho, x) && \qquad\text{for $\dist{i}{j} < x \le |\bar{a}|$}
%   \end{alignat*}
% \end{definition}

\pagebreak

\begin{lemma}
  $\struct{A} \sim_{\mathrm{FGF}} \struct{A}^{\rightarrow{}}$
\end{lemma}
\begin{proof}
  We show that the set $\mathcal{Z}$, defined as follows, is FGF bisimulation:
  \begin{equation*}
    (\bar{a}, \bar{a}^{*}) \in \mathcal{Z} \iff
    \bar{a} = \pi[\bar{a}^{*}] \text{\ and\ }
    \bar{a}^{*} \text{\ is live}
  \end{equation*}

  \begin{description}
    \item[(atomic harmony)]
          Let $(\bar{a}, \bar{a}^{*}) \in \mathcal{Z}$.
          We show that $\bar{a}_{i\ldots{}j} \in R^{\struct{A}} \iff \bar{a}^{*}_{i\ldots{}j} \in R^{\struct{A}^{\rightarrow}}$.
          From $\bar{a} = \pi[\bar{a}^{*}]$ follows that $\bar{a}_{i\ldots{}j} = \pi[\bar{a}^{*}_{i\ldots{}j}]$.
          By definition of the unraveling $\bar{a}^{*}_{i\ldots{}j} \in R^{\struct{A}^{\rightarrow}}$ implies $\pi[\bar{a}^{*}_{i\ldots{}j}] \in R^{\struct{A}}$ leaving only the ``$\implies$'' direction to be shown.
          We prove the three conditions required for $\bar{a}^{*}_{i\ldots{}j} \in R^{\struct{A}^{\rightarrow}}$:
          \begin{itemize}
            \item
                  $\pi[\bar{a}^{*}_{i\ldots{}j}] \in R^{\mathfrak{A}}$ follows directly from $\bar{a}_{i\ldots{}j} \in R^{\mathfrak{A}}$.
            \item
                  $\bigwedge_{k=1}^{|\bar{a}^{*}_{i\ldots{}j}|-1}{(\nextrel{\bar{a}^{*}_{i\ldots{}j,k}}{{}\bar{a}^{*}_{i\ldots{}j,k+1}})}$ is true since $\bar{a}^{*}$ is live so $\nextrel{a^{*}_{k}}{a^{*}_{k+1}}$ for all $1 \le k < |\bar{a}^{*}|$.
            \item
                  To show that $|\bar{a}^{*}_{i\ldots{j}}| \le \mathtt{bound}(\bar{a}^{*}_{i\ldots{}j})$, let $\bar{a}^{*} = ((\sigma_{1}, x_{1}), \ldots{}, (\sigma_{n}, x_{n}))$.
                  We know that for all $1 < k \le |\bar{a}^{*}|$ we have $\nextrel{(\sigma_{k-1}, x_{k-1})}{(\sigma_{k}, x_{k})}$ since $\bar{a}^{*}$ is live.
                  This implies $x_{k-1} \ge x_{k} - 1$ as can be seen by analysing the two cases of the definition of $\mathit{Next}$.
                  Since $\bar{a}^{*}$ is live we have $\mathtt{bound}(\bar{a}^{*}) = x_{n} \ge n = |\bar{a}^{*}|$.
                  It follows that $x_{k} \ge k$ for all $k$, so $\mathtt{bound}(\bar{a}^{*}_{i\ldots{}j}) = x_{j} \ge j \ge |\bar{a}^{*}_{i\ldots{j}}|$ as required.
          \end{itemize}
    \item[(fgforth)]
          Let $(\bar{a}, \bar{a}^{*}) \in \mathcal{Z}$ and $\bar{b} \in \mathfrak{A}$ be a live tuple such that $\bar{a}\sij = \bar{b}_{1\ldots{}\dist{i}{j}}$ for some $i,j$.
          We show that there exists $\bar{b}^{*}$ such that $\bar{a}^{*}\sij = \bar{b}^{*}_{1\ldots{}\dist{i}{j}}$ and $(\bar{b}, \bar{b}^{*}) \in \mathcal{Z}$.

          We first consider the case where $\bar{b}_{1\ldots{}\dist{i}{j}}$ is a proper, non-empty prefix of $\bar{b}$.
          Let $\sigma$ and $k$ be the bisimulation sequence and index such that $b_{j} = (\sigma, k)$.
          We choose $\bar{b}^{*}$ to be the tuple such that:
          \begin{alignat*}{2}
            &\bar{b}^{*}_{1\ldots{}\dist{i}{j}} &&= \bar{a}\sij \\
            &\bar{b}^{*}_{x} &&= (\sigma (i,j) \bar{b}, x) \qquad \text{for\ }\dist{i}{j} < x \le |\bar{b}|
          \end{alignat*}
          Note that \fxnote*{more detail}{$\sigma (i,j) \bar{b}$ is a valid bisimulation sequence}, $\bigwedge_{k=1}^{|\bar{b}^{*}|-1}{\nextrel{b^{*}_{k}}{b^{*}_{k+1}}}$ and $|\bar{b}^{*}| \le \mathtt{bound}(\bar{b}^{*}) = |\bar{b}|$.
          Since $\pi[\bar{b}^{*}] = \bar{b}$ and $\bar{b}$ is live, it follows that $\bar{b}^{*}$ is also live, so $(\bar{b}, \bar{b}^{*}) \in \mathcal{Z}$ as required.

          Now consider the case where $\bar{b}_{1\ldots{}\dist{i}{j}}$ is not a proper prefix, so it is either empty or equal to $\bar{b}$.
          If it is equal to $\bar{b}$, then $\bar{b}$ is an infix of $\bar{a}$.
          So by atomic harmony, $\bar{b}^{*} = \bar{a}^{*}\sij$ is live since $\bar{b}$ is live and satisfies $(\bar{b}, \bar{b}^{*}) \in \mathcal{Z}$.
          If it is empty, let $\bar{b}^{*} = ((\bar{b}, 1), \ldots{}, (\bar{b}, |b|))$.
          Again $\bar{b}^{*}$ is live since $\bar{b}$ is live and satisfies $(\bar{b}, \bar{b}^{*}) \in \mathcal{Z}$.

          % We define $$
          %  $\bar{
          % First consider the case where $\bar{a}$ and $\bar{b}$ share no elements, so $|\bar{a}\sij| = 0$.
          % As $(\bar{b}, \lift{\bar{b}}) \in \mathcal{Z}$, we can pick $\bar{b}^{*} = \lift{\bar{b}}$ to satisfy the conditions.
    \item[(fgfback)]
          This case follows directly from the definition of the unraveling.
          Let $(\bar{a}, \bar{a}^{*}) \in \mathcal{Z}$ and $\bar{b}^{*} \in \mathfrak{A}^{\rightarrow}$ be a live tuple such that $\bar{a}^{*}\sij = \bar{b}^{*}_{1\ldots{}\dist{i}{j}}$ for some $i,j$.
          Then $\bar{b} = \pi[\bar{b}^{*}]$ also has $\bar{a}_{i\ldots{}j} = \bar{b}_{1\ldots{}\dist{i}{j}}$ (since the projection is pointwise) and satisfies $(\bar{b}, \bar{b}^{*}) \in \mathcal{Z}$ as required.
  \end{description}
\end{proof}

\pagebreak

\begin{lemma}\label{lem:fgf-intersection-continuous}
  If two tuples $\overrightarrow{a}, \overrightarrow{a}' \in \struct{A}^{\rightarrow}$ intersect, then $\overrightarrow{a} \cap \overrightarrow{a}'$ is an infix of both $\overrightarrow{a}, \overrightarrow{a}'$ and
  $\overrightarrow{a} \cap \overrightarrow{a}'$ is a prefix of at least one of $\overrightarrow{a}, \overrightarrow{a}'$.
\end{lemma}

\begin{definition}[maximal tuples]
  A live tuple $\bar{a}$ is \emph{maximal} if it is not an infix of any other live tuple.
\end{definition}

\begin{lemma}\label{lem:maximal-tuple-sequences}
  For two maximal tuples $\overrightarrow{a}, \overrightarrow{b} \in \struct{A}^{\rightarrow}$, if $\seq{\overrightarrow{a}_{|\overrightarrow{a}|}} = \seq{\overrightarrow{b}_{|\overrightarrow{b}|}}$, then $\overrightarrow{a} = \overrightarrow{b}$.
\end{lemma}
\begin{proof}
  Let $\overrightarrow{a}_{|\overrightarrow{a}|} = (\sigma, x)$ and $\overrightarrow{b}_{|\overrightarrow{b}|} = (\sigma, y)$ for some $\sigma, x, y$.
  Let $\bar{s}$ be the last tuple of $\sigma$, so that $\sigma = \cdots{}\bar{s}$.
  By the definition of the unraveling domain, $x \le |\bar{s}|$ and $y \le |\bar{s}|$.
  We also have $|\overrightarrow{a}| \le x = \mathtt{bound}(\overrightarrow{a})$ by the definition of relations in the unraveling, and the same for $\overrightarrow{b}$ with $y$.
  It follows that $|\overrightarrow{a}|, |\overrightarrow{b}| \le |\bar{s}|$.
  We will show that there is a tuple $\overrightarrow{c} \in \struct{A}^{\rightarrow}$ with $|\overrightarrow{c}| = |\bar{s}|$ and both $(\sigma, x) \in \overrightarrow{c}$ and $(\sigma, y) \in \overrightarrow{c}$.
  By the uniqueness of predecessors of ``$\mathit{Next}$'' and since $|\overrightarrow{a}|, |\overrightarrow{b}| \le |\bar{s}|$, this implies that $\overrightarrow{a}, \overrightarrow{b}$ are both infixes of $\overrightarrow{c}$.
  By maximality, they must therefore both be equal to $\overrightarrow{c}$.

  We construct the tuple $\bar{c}$ using a mapping $\mathtt{lift}$ from bisimulation sequences in $\struct{A}$ to tuples of $\struct{A}^{\rightarrow}$, starting by mapping bisimulation sequences of just a single tuple $\bar{a}$:
  \begin{alignat*}{3}
    &\lift{\bar{a}} &&= ((\bar{a}, 1), \ldots{}, (\bar{a}, |a|)) \\
    \intertext{For longer bisimulation sequences, $\lift{\rho(i,j)\bar{a}}$ is then defined in terms of $\lift{\rho}$:}
    &{\lift{\rho(i,j)\bar{a}}}_{1\ldots{}\dist{i}{j}} &&= {\lift{\rho}}_{i\ldots{}j} && \\
    &{\lift{\rho(i,j)\bar{a}}}_{x} &&= (\rho(i,j)\bar{a}, x) && \qquad\text{for $\dist{i}{j} < x \le |\bar{a}|$}
  \end{alignat*}
  Then, $\overrightarrow{c} = \lift{\sigma}$.
  By construction, $\lift{\sigma}$ is live.
  Also, $\pi[\lift{\sigma}] = \bar{s}$, so $|\overrightarrow{c}| = |\bar{s}|$ as required.
\end{proof}

\begin{lemma}
  If $\struct{A} \sim_{\mathrm{FGF},2*W*l} \struct{B}$, then $\struct{A}^{\rightarrow} \sim_{\mathrm{GF},l} \struct{B}^{\rightarrow}$
\end{lemma}
\begin{proof}

  Let $\mathcal{Z}_{0}, \ldots, \mathcal{Z}_{l}$ be a sequence of sets, each defined as follows:
  \fxnote{
    $\seq{a_{x}} \approx_{\alpha} \seq{b_{x}}$ is almost implied by $\seq{a_{n}} \approx_{\alpha} \seq{b_{n}}$ due to the definition of ``$\mathit{Next}$''.
    The only difference is that since $\seq{a_{1}}$ is shorter, this increases the ``lookback'' (how many elements from the end of the sequence of $a_n$ we consider) by at most the width.
  }{\begin{equation*}
      (\overrightarrow{a}, \overrightarrow{b}) \in \mathcal{Z}_{\alpha}\ \iff \left\{
        \begin{array}{lll}
          |\overrightarrow{a}| = |\overrightarrow{b}| & \text{with\ } n = |a| = |b| & \wedge \\
          \num{\overrightarrow{a}_{x}} = \num{\overrightarrow{b}_{x}} & \text{for all\ } 1 \le x \le |\overrightarrow{a}| & \wedge \\
          \seq{\overrightarrow{a}_{x}} \approx_{W * \alpha} \seq{\overrightarrow{b}_{x}} & \text{for all\ } 1 \le x \le |\overrightarrow{a}| &
        \end{array}
      \right.
    \end{equation*}}
  where $\sigma \approx_{\beta} \rho$ for $\sigma = \bar{s}_{0}\cdots{}(i_{n}, j_{n})\bar{s}_{n}$ and $\rho = \bar{r}_{0}\cdots{}(v_{m}, w_{m})\bar{r}_{m}$ iff:
  \begin{enumerate}
    \item
          last $\beta$ indices match: $i_{n-x} = v_{m-x} \wedge j_{n-x} = u_{m-x}$ for all $x \le \beta$, and
    \item
         last $\beta$ tuples are bisimilar: $\bar{s}_{n-x} \sim_{\mathrm{FGF},\beta} \bar{r}_{m-x}$ for all $x \le \beta$
  \end{enumerate}
  We show that each $\mathcal{Z}_{\alpha-1}$ has the back-and-forth property for $\mathcal{Z}_{\alpha}$ and satisfies atomic harmony.

  \paragraph{Atomic harmony}
  Let $(\overrightarrow{a}, \overrightarrow{b}) \in \mathcal{Z}_{\alpha}$.
  Let $\sigma = \cdots{}\bar{s}$ be a bisimulation sequence ending in $\bar{s}$.
  Observe that for any tuple $\overrightarrow{a} = (\overrightarrow{a}_{1}, \ldots{}, \overrightarrow{a}_{n})$ with $\seq{\overrightarrow{a}_{n}} = \sigma$, we have that $\pi(\overrightarrow{a}_{x}) = s_{\num{\overrightarrow{a}_{x}}}$.
  Thus, by definition of $\mathcal{Z}_{a}$ and ``$\approx_{\beta}$'' it follows that $\pi[\overrightarrow{a}] \sim_{\mathrm{FGF},W*\alpha} \pi[\overrightarrow{b}]$ which implies that $\mathrm{ftp}(\overrightarrow{a}) = \mathrm{ftp}(\overrightarrow{b})$.
  Since forward-type equivalence is the same as full atomic type equivalence in tree unravelings, this shows that $\mathcal{Z}_{\alpha}$ respects atomic harmony.

  \paragraph{Back-and-forth property}
  Now let $(\overrightarrow{a}, \overrightarrow{b}) \in \mathcal{Z}_{\alpha}$ and $\overrightarrow{a}'$ be a guarded tuple in $\struct{A}^{\rightarrow}$.
  Since all guarded tuples in an unraveling are also live, \cref{lem:fgf-intersection-continuous} applies so the common elements of $\overrightarrow{a} \cap \overrightarrow{a}'$ must be a prefix of one of $\overrightarrow{a}, \overrightarrow{a}'$.
  We call the case where $\overrightarrow{a} \cap \overrightarrow{a}'$ is a prefix of $\overrightarrow{a}'$ the \emph{forward case}, and the other case the \emph{backward case}.

  \paragraph{The forward case.}
  Let $\overrightarrow{a}\sij$ be the infix of $\overrightarrow{a}$ which is a prefix of $\overrightarrow{a}'$.
  We construct a tuple $\overrightarrow{b}'$ with $\overrightarrow{b}'_{1\ldots{}\dist{i}{j}} = \overrightarrow{b}\sij$ and $(\overrightarrow{a}', \overrightarrow{b}') \in \mathcal{Z}_{\alpha-1}$.
  Since $\overrightarrow{b}'_{1\ldots{}\dist{i}{j}} = \overrightarrow{b}\sij$ \fxwarning*{This only works if the overlap is nonempty. But if the overlap is empty, we can simply treat this as restarting the game, so we handle this case the same way that we handle the start of the game}{we already know the first elements} of $\overrightarrow{b}'$.
  For some $x$, let $\num{\overrightarrow{b}'_{x}} = \num{\overrightarrow{a}'_{x}}$ and $\seq{\overrightarrow{b}'_{x}} \approx_{\beta} \seq{\overrightarrow{a}'_{x}}$.
  We show how to find $\overrightarrow{b}'_{x+1}$ with $\num{\overrightarrow{b}'_{x+1}} = \num{\overrightarrow{a}'_{x+1}}$ and $\seq{\overrightarrow{b}'_{x+1}} \approx_{\beta} \seq{\overrightarrow{a}'_{x+1}}$.

  If $\seq{\overrightarrow{a}'_{x+1}} = \seq{\overrightarrow{a}_{x}}$, then we can set $\overrightarrow{b}'_{x+1} = (\seq{\overrightarrow{b}'}_{x}, \num{\overrightarrow{a}'_{x+1}})$ and are done.
  By definition of ``$\mathit{Next}$'', the only remaining case is that $\seq{\overrightarrow{a}'_{x+1}} = \seq{\overrightarrow{a}'_{x}} (v, w) \bar{t}$.
  Let $\seq{\overrightarrow{a}'_{x}} = \cdots{}\bar{s}$ and $\seq{\overrightarrow{b}'_{x}} = \cdots{}\bar{o}$.
  By definition of ``$\approx_{\beta}$'', we know that $\bar{s} \sim_{\mathrm{FGF},\beta} \bar{o}$.
  Using the \textbf{(fgforth)} property of FGF, we can find $\bar{p}$ such that $\bar{t} \sim_{\mathrm{FGF},\beta-1} \bar{p}$ and $\bar{p}_{1\ldots{}\dist{v}{w}} = \bar{o}_{v\ldots{}w}$.
  Then $\theta = \seq{\overrightarrow{b}'_{x}} (v,w) \bar{t}$ is a valid bisimulation sequence and $\theta \approx_{\beta-1} \seq{\overrightarrow{a}'_{x+1}}$ by construction.
  So $\overrightarrow{b}_{x+1} = (\theta, \num{\overrightarrow{a}_{x+1}})$ has the required properties.

  We need to apply the above procedure at most $|\overrightarrow{b}'| = |\overrightarrow{a}'| \le W$ times to construct all elements of $\overrightarrow{b}'$.
  Therefore we have $\seq{\overrightarrow{b}'_{x}} \approx_{W*\alpha-W} \seq{\overrightarrow{a}'_{x}}$ for all $1 \le x \le |\overrightarrow{b}'|$.
  As we also preserve the equivalence of counters with each step, it follows that $(\overrightarrow{a}', \overrightarrow{b}') \in \mathcal{Z}_{\alpha-1}$.

  \paragraph{The backward case.}
  For the backward case, we first only consider tuples which are not infixes of any other live tuple, which we call \emph{maximal}.
  Let $\overrightarrow{a}$, $\overrightarrow{b}$ and $\overrightarrow{a}'$ be maximal tuples, and $\overrightarrow{a}'\sij$ be a prefix of $\overrightarrow{a}$.
  Let $\sigma = \seq{\overrightarrow{a}_{|\overrightarrow{a}|}}$ be the sequence of the last element of $\overrightarrow{a}$, and $\sigma =  \seq{\overrightarrow{a}'_{j}}$ be the sequence of the last element of the common infix.
  By definition of ``$\mathit{Next}$'', we know that $\sigma'$ is a prefix of $\sigma$.
  Let $\overrightarrow{c}$ be the maximal tuple containing $\overrightarrow{a}'_{j}$.

  First consider the situation where $\sigma' = \sigma$, implying $\overrightarrow{c} = \overrightarrow{a}$.
  We will show that then $\overrightarrow{a'}_{1} \in \overrightarrow{c}$, meaning that this case is actually a forward case and we are done.

  We then
  We show that then $\overrightarrow{a}_{|\overrightarrow{a}|}$ is contained in $\overrightarrow{a}'$, therefore $\overrightarrow{a}$ is an infix of $\overrightarrow{a}'$ and by maximality both tuples are equal.


\end{proof}
\end{document}

% additional elements
