\ifmainpart
\vanbenthemFGF
\else
  \section{Main Theorem}
  \vanbenthemFGF*
\fi
\ifmainpart
\newsavebox{\diagupgrading}
\begin{lrbox}{\diagupgrading}{
  \begin{tikzpicture}
    \matrix[row sep=2em, column sep=3em]
    {
        \node (a) {$(\str{A}, \elemtuplea)$}; &
         \node[font=\large] (sim_ab) {$\bisimto_{\FGF}^{\homop(\mathit{g})}$}; &
        \node (b) {$(\str{B}, \elemtupleb)$}; &
        \node[anchor=west] {}; \\

        \node[font=\large] (sim_a_unravel) {$\bisimto_{\FGF}$}; &
        \node {}; &
        \node[font=\large] (sim_b_unravel) {$\bisimto_{\FGF}$}; &
        \node[anchor=west] {}; \\

        \node (a_unravel) {$(\str{A}', \elemtuplea')$}; &
        \node[font=\large] (sim_unravel) {$\bisimto_{\GF}^{\mathit{g}}$}; &
        \node (b_unravel) {$(\str{B}', \elemtupleb')$};
        \node[anchor=west] {}; \\
    };

    \draw[->] (a) -- (sim_ab) -> (b);
    \draw[dashed,->] (a) -- (sim_a_unravel) -> (a_unravel);
    \draw[->] (a_unravel) -- (sim_unravel) -> (b_unravel);
    \draw[dashed,->] (b_unravel) -- (sim_b_unravel) -> (b);
  \end{tikzpicture}
}
\end{lrbox}
\begin{proofsketch}
  The invariance of $\FGF$ under $\bisimto_{\FGF}$ was already shown in \cref{lem:FGF-bisimulations-work-well}, hence what is left to show is the expressive completeness.
  By \cref{cor:ell-invariant-has-ell-formula}, it suffices to show that for every first-order formula that is $\bisimto_{\FGF}$-invariant (in the finite) is also $\bisimto_{\FGF}^{\ell}$-invariant (in the finite) for some $\ell \in \N$.
  Like Otto, we employ an ``upgrading'' to show this.
  For structures $\str{A}, \elemtuplea$ and $\str{B}, \elemtupleb$, the upgrading is shown in the following diagram:
  \begin{center}%
    \usebox{\diagupgrading}
  \end{center}
  where $\str{A'}, \elemtuplea'$, $\str{B'}, \elemtupleb'$ are the companions and $\homop$ is the polynomial function as given by \cref{thm:main-technical-thm}.
  For every $\bisimto_{\FGF}$-invariant (and hence also $\bisimto_{\GF}$-invariant) $\FO$-formula $\phi$, there is a number $g$ such that $\phi$ is $\bisimto_{\GF}^{g}$ invariant (\cref{thm:vanBenthem-for-GF}).
  By the above diagram, this implies that $\phi$ is $\bisimto_{\FGF}^{\homop(g)}$ invariant.
  Since all the structures involved in the proof are finite if $\str{A}, \elemtuplea$ and $\str{B},  \elemtupleb$ are finite, this works for both classical model theory and in the finite, concluding the proof.
\end{proofsketch}
\else
\begin{proof}
  The invariance of $\FGF$ under $\bisimto_{\FGF}$ was already shown in \cref{lem:FGF-bisimulations-work-well}, hence what is left to show is the expressive completeness.
By \cref{cor:ell-invariant-has-ell-formula}, it suffices to show that for every first-order formula that is $\bisimto_{\FGF}$-invariant (in the finite) is also $\bisimto_{\FGF}^{\ell}$-invariant (in the finite) for some $\ell \in \N$.

Take any such first-order formula $\varphi$, and let $\homop$ be the function provided by~\cref{thm:main-technical-thm}.
As $\FGF$ is a fragment of $\GF$ (and hence $\bisimto_{\FGF}$-invariance implies $\bisimto_{\GF}$-invariance), we know that $\varphi$ is $\bisimto_{\GF}$-invariant (in the finite).
Thus $\varphi$ is also $\bisimto_{\GF}^{\mathit{g}}$-invariant (in the finite) for certain threshold $\mathit{g} \in \N$ provided by~\cref{thm:vanBenthem-for-GF}.
We aim to show that $\varphi$ is $\bisimto_{\FGF}^{\homop(\mathit{g})}$-invariant (in the finite).
To do so, let $(\str{A}, \elemtuplea)$ and $(\str{B}, \elemtupleb)$ be $\homop(\mathit{g})$-$\FGF$-bisimilar pointed structures, and suppose that $(\str{A}, \elemtuplea) \models \varphi$. It remains to show that $(\str{B}, \elemtupleb) \models \varphi$.
From~\cref{thm:main-technical-thm} we infer the existence of $\FGF$-bisimilar companions $(\str{A}', \elemtuplea')$ and $(\str{B}', \elemtupleb')$, that are finite if $\str{A}$ and $\str{B}$ are, for which $(\str{A}', \elemtuplea') \bisimto^{\mathit{g}}_{\GF} (\str{B}', \elemtupleb')$ holds.
The following diagram depicts what will happen next.
\begin{figure}[H]
  \centering
  \usebox{\diagupgrading}
  % \caption{Upgrading $\bisimto_{\FGF}^{\ell}$-bisimulation to $\bisimto_{\GF}^{\mathit{g}}$-bisimulation.}
\end{figure}

It is now clear that:
(i) $(\str{A}, \elemtuplea) \models \varphi$ (by assumption),
(ii) $(\str{A}', \elemtuplea') \models \varphi$ (by $\FGF$-bisimilarity and $\bisimto_{\FGF}$-invariance of $\varphi$),
(iii) $(\str{B}', \elemtupleb') \models \varphi$ (by $\bisimto_{\GF}^{\mathit{g}}$-invariance of $\varphi$),
(iv) $(\str{B}, \elemtupleb) \models \varphi$ (by $\FGF$-bisimilarity and $\bisimto_{\FGF}$-invariance of $\varphi$).
This concludes the proof.
\end{proof}
\fi
