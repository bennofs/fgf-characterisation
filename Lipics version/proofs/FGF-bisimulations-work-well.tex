\ifmainpart
\begin{restatable}{lemma}{fgfbisimwork}\label{lem:FGF-bisimulations-work-well}
For every pair of pointed structures $(\str{A}, \elemtuplea)$ and~$(\str{B}, \elemtupleb)$ we have that:
\begin{enumerate}[(a)]
\item $(\str{A}, \elemtuplea) \bisimto_{\FGF} (\str{B}, \elemtupleb)$ implies $(\str{A}, \elemtuplea) \equiv_{\FGF} (\str{B}, \elemtupleb)$, the converse holds for $\omega$-saturated $\str{A}$ and $\str{B}$;
\item $(\str{A}, \elemtuplea) \bisimto_{\FGF}^{\ell} (\str{B}, \elemtupleb)$ implies $(\str{A}, \elemtuplea) \equiv_{\FGF_\ell} (\str{B}, \elemtupleb)$ for all $\ell \in \N$;
\end{enumerate}
\end{restatable}
\else
  % \section{Lemma~\ref{lem:FGF-bisimulations-work-well}}
  % \fgfbisimwork*
\fi
% \ifmainpart
% \begin{proofsketch}
%   A proof for condition \textbf{(a)} is provided in~\cite[Lemma 3]{BednarczykJ22}.
%   The proof for condition \textbf{(b)} uses the same ideas as the proof for \textbf{(a)}.
%   \begin{itemize}
%     \item
%           For the ``if'' direction, we perform induction over $\ell$ and use~\ref{bisim:fforth} to obtain a witness in $\str{B}$ for every existential quantifier that has a witness in $\str{A}$ (by properties of $\models$, it suffixes to consider existential quantifiers as $\forall\vartuplex\ \cdots \iff \lnot \exists \vartuplex\ \cdots$).
%     \item
%           For the opposite direction, we show that the set of pairs of tuples from $\str{A}$ and $\str{B}$ with the same $\FGF_{\ell}$-type is an $\ell$-$\FGF$-bisimulation.
%           Let $\elemtuplec \sqin A$ and $\elemtupled \sqin B$ be live tuples with equal $\FGF_{\ell}$-types.
%           Consider any tuple $\elemtuplee$ extending an infix $\elemtuplecfromto{i}{j}$ to a new live tuple $\elemtuplecfromto{i}{j}\elemtuplee$.
%           Let $\Gamma$ be the $\FGF_{k-1}$-type of $\elemtuplee$ with regards to $\elemtuplecfromto{i}{j}$.
%           There are only finitely many (up to equivalence) $\FGF_{k{-}1}$ formulae, so $\Gamma$ is logically equivalent to some finite set $\Delta$.
%           For this finite set $\Delta$, we can construct an $\FGF_{k}$-formula that asserts the existence of a witness realizing this finite $\FGF_{k-1}$-type.
%           Hence by $k$-$\FGF$-equivalence, there exists a tuple $\elemtuplef$ that extends $\elemtupledfromto{i}{j}$ and same $\FGF_{k-1}$-type.
%           Therefore, the set of pairs of tuples with equal $\FGF_{\ell}$-types is an $\ell$-$\FGF$-bisimulation, satisfying the theorem.
%   \end{itemize}
% \end{proofsketch}
% \else
\begin{proof}
  A proof for condition \textbf{(a)} is provided in~\cite[Lemma 3]{BednarczykJ22}, and thus we proceed with condition \textbf{(b)}.
  We start from the ``if'' direction.
  Let us fix structures $\str{A}$ and $\str{B}$.
  We want to establish that for all $\ell \in \N$, $\elemtuplea$ in $\str{A}$, and $\elemtupleb$ in $\str{B}$ the following condition holds:
  \[
    (\heartsuit_\ell)(\elemtuplea, \elemtupleb){:} \ \ \ \  (\str{A}, \elemtuplea) \bisimto_{\FGF}^{\ell} (\str{B}, \elemtupleb) \ \text{implies} \ (\str{A}, \elemtuplea) \equiv_{\FGF_\ell} (\str{B}, \elemtupleb).
  \]
  We proceed by induction.
  For the inductive base, take any $\elemtuplea$ from $\str{A}$, any $\elemtupleb$ from $\str{B}$, and suppose that the antecedent of $(\heartsuit_0)(\elemtuplea,\elemtupleb)$ holds.
  Thus, by definition of forward partial maps, we know that $\elemtuplea$ and~$\elemtupleb$ have equal $\FGF$-types.
  This means that for all atomic $\varphi$ of $\FGF$ we have $\str{A} \models \varphi[\elemtuplea]$ if and only if $\str{B} \models \varphi[\elemtupleb]$.
  Hence, by a routine case analysis employing obvious properties of $\models$ relation, the above equivalence is lifted to the case of all quantifier-free $\FGF$-formulae, establishing the consequent of $(\heartsuit_0)(\elemtuplea,\elemtupleb)$.
  For the inductive step, fix any positive $\ell$ and assume that for all $k$ smaller than $\ell$ and the condition $(\heartsuit_k)(\elemtuplea,\elemtupleb)$ is satisfied for all tuples $\elemtuplea$ and $\elemtupleb$.
  Now take any tuple $\elemtuplea$ from $\str{A}$ and $\elemtupleb$ from $\str{B}$.
  To show the consequent of $(\heartsuit_\ell)(\elemtuplea,\elemtupleb)$, we take any formula $\varphi(x_1, \ldots, x_n) \in \FGF_\ell$.
  If the quantifier rank of $\varphi$ is smaller than $\ell$, then we are done by $(\heartsuit_{\ell{-}1})(\elemtuplea,\elemtupleb)$.
  Hence, suppose that the quantifier rank of $\varphi$ is precisely~$\ell$.
  By structural induction (relying on properties of $\models$ relation) it amounts to establish the equivalence for $\varphi$ in one of the following forms:
  \begin{itemize}\itemsep0em

  \item $\varphi$ is of the form $\exists{\vartuplexfromto{n{+}1}{m}}\ \relR(\vartuplexfromto{i}{j}) \land \psi(\vartuplexfromto{i}{j})$, where a predicate $\relR$ serves as a guard, $i \geq 1$ and $j \leq m$.
  Note that the quantifier rank of $\relR(\vartuplexfromto{i}{j}) \land \psi(\vartuplexfromto{i}{j})$ is less than $\ell$.
  Suppose that $\str{A} \models \varphi[\elemtuplea]$ (the case of $\str{B} \models \varphi[\elemtupleb]$ is symmetric).
  Let $\elemtuplec$ be the (possibly empty) infix $\elemtupleafromto{i}{n}$ of~$\elemtuplea$.
  Then there exists a (possibly empty) tuple $\elemtuplee$ in $\str{A}$ such that $\str{A} \models \relR[\elemtuplec\elemtuplee] \land \psi[\elemtuplec\elemtuplee]$.
  Note that $\elemtuplec\elemtuplee$ is live.
  By~\ref{bisim:fforth} we can find a (possibly empty) tuple $\elemtuplef$ in $\str{B}$ such that $(\str{A}, \elemtuplec\elemtuplee) \bisimto_{\FGF}^{\ell{-}1} (\str{B}, \elemtupled\elemtuplef)$ for~$\elemtupled$ equal to $\elemtuplebfromto{i}{n}$.
  Applying inductive hypothesis, namely $(\heartsuit_{\ell{-}1})(\elemtuplec\elemtuplee,\elemtupled\elemtuplef)$, we know that the consequent of $(\heartsuit_{\ell{-}1})(\elemtuplec\elemtuplee,\elemtupled\elemtuplef)$ holds true.
  This clearly implies $\str{B} \models \relR[\elemtupled\elemtuplef] \land \psi[\elemtupled\elemtuplef]$, which finally lead us to $\str{B} \models \varphi[\elemtupleb]$.

  \item $\varphi$ is of the form $\exists{x_{1}} \psi(x_1)$. Then the quantifier rank of $\psi$ is less than $\ell$.
  Suppose that $\str{A} \models \varphi[\elemtuplea]$ (the case of $\str{B} \models \varphi[\elemtupleb]$ is symmetric).
  Then there exists an element $\elem{c}$ in $\str{A}$ for which $\str{A} \models \psi[\elem{c}]$.
  As $\elem{c}$ is trivially guarded, we apply~\ref{bisim:fforth} to find $\elem{d}$ in $\str{B}$ for which $(\str{A}, \elem{c}) \bisimto_{\FGF}^{\ell{-}1} (\str{B}, \elem{d})$.
  Note that $\ell{-}1$ is non-negative by positivity of $\ell$.
  Thus, by $(\heartsuit_{\ell{-}1})(\elem{c},\elem{d})$ we know that $(\str{A}, \elem{c}) \equiv_{\FGF_{\ell{-}1}} (\str{B}, \elem{d})$ holds.
  In particular, this implies $\str{B} \models \psi[\elem{d}]$, concluding the proof.
\end{itemize}

For the opposite direction, take $\ell \in \N$ and a pair of $\omega$-saturated pointed structures $(\str{A}, \elemtuplea)$ and $(\str{B}, \elemtupleb)$.
Suppose that $(\str{A}, \elemtuplea) \equiv_{\FGF_\ell} (\str{B}, \elemtupleb)$.
We construct a family $\bisimZ_0, \ldots, \bisimZ_\ell$ of systems of forward partial maps as follows:
\[
	\bisimZ_{\mathit{k}} \coloneqq \{ (\elemtuplec, \elemtupled) \in \bigcup_{i=0}^{\infty} (A^i \times B^i) \colon\,  (\str{A}, \elemtuplec) \equiv_{\FGF_{\mathit{k}}} (\str{B}, \elemtupled), \ \text{and} \ \elemtuplec, \elemtupled \ \text{are live} \}.
\]
We claim that such a family is an $\ell$-$\FGF$-bisimulation between $(\str{A}, \elemtuplea)$ and $(\str{B}, \elemtupleb)$.
	Note that the condition of forward partial maps is trivially satisfied by all the $\bisimZ_{\mathit{k}}$ above, and that $(\elemtuplea, \elemtupleb)$ belongs to all the sets $\bisimZ_{\mathit{k}}$ by design.
Thus it suffices to show that for all $\mathit{k} \in \{ 1, 2, \ldots, \ell\}$ that the system of forward partial
maps $\bisimZ_{k-1}$ satisfies \ref{bisim:fforth} and \ref{bisim:fback} for $\bisimZ_{\mathit{k}}$.
Hence, take any such $j$ and let us proceed with a proof of \ref{bisim:fforth} (the case of \ref{bisim:fback} is symmetric).
	Let $(\elemtuplec, \elemtupled) \in \bisimZ_{\mathit{k}}$, $\elemtuplecfromto{i}{j}$ be a (possibly empty) infix of $\elemtuplec$
and $\elemtuplee$ be any tuple in $\str{A}$ such that $\elemtuplecfromto{i}{j}\elemtuplee$ is live.
We are going to show that the set
\[
  \Gamma \deff \{ \varphi \colon\, \str{A} \models \varphi[\elemtuplecfromto{i}{j}\elemtuplee], \varphi \in \FGF_{\mathit{k}{-}1} \}
\]
is realized in $\str{B}$ by $\elemtupledfromto{i}{j}\elemtuplef$ for some $|\elemtuplee|$-tuple $\elemtuplef$ from $\str{B}$.
There are only finitely many (up to equivalence) $\FGF_{k{-}1}$ formulae, so $\Gamma$ is logically equivalent to some finite set $\Delta$.
It suffices to establish that $\Delta$ is realized by $\elemtupledfromto{i}{j}\elemtuplef$ for some $|\elemtuplee|$-tuple $\elemtuplef$ from $\str{B}$.
Since $\elemtuplecfromto{i}{j}\elemtuplee$ is live, there must be an atomic formula $\alpha$ such $(\str{A}, \elemtuplecfromto{i}{j}\elemtuplee) \models \alpha$.
The formula
\begin{equation*}
  \phi(\vartuplex) \deff \exists{\vartupley} \; (\alpha(\vartuplex, \vartupley) \wedge \textstyle\bigwedge_{\delta \in \Delta} \delta(\vartuplex, \vartupley))
\end{equation*}
satisfies $(\str{A}, \elemtuplecfromto{i}{j}) \models \phi$ by design.
Moreover, as $\phi$ is an $\FGF_{\mathit{k}}$-formula,
we can invoke $\mathit{k}$-$\FGF$-equivalence of $(\str{A}, \elemtuplec)$ and $(\str{B}, \elemtupled)$ to deduce~$(\str{B}, \elemtupledfromto{i}{j}) \models \phi$.
This implies that $\Gamma$ is indeed realized in $\str{B}$, we let $\elemtupledfromto{i}{j}\elemtuplef$ be a tuple witnessing this fact.
By the choice of $\Gamma$, we know that  $(\str{A}, \elemtuplecfromto{i}{j}\elemtuplee) \equiv_{\FGF_{\mathit{k}{-}1}} (\str{B}, \elemtupledfromto{i}{j}\elemtuplef)$, and hence
$(\elemtuplecfromto{i}{j}\elemtuplee, \elemtupledfromto{i}{j}\elemtuplef) \in \bisimZ_{\mathit{k}{-}1}$.
This concludes the proof of that $\bisimZ_{\mathit{k}}$ satisfies \ref{bisim:fforth}, and thus concludes the proof that the family $\bisimZ_0, \ldots, \bisimZ_\ell$ is an $\ell$-$\FGF$-bisimulation between $(\str{A}, \elemtuplea)$ and $(\str{B}, \elemtupleb)$.
\end{proof}
% \fi
