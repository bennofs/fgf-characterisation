%!TEX root = ../main.tex

\section{Finite Companions}\label{sec:finite}
Let $\unravel{A}, \elemtuptuplea$ be a tree unraveling of a finite structure $\str{A}, \elemtuplea$ over a signature $\sigma$.
We describe the finite unraveling $\unravel{A}_{\ell}, \elemtuptuplea_{\ell}$ which will be $\ell$-$\FGF$-bisimilar to $\unravel{A}, \elemtuptuplea$ (and also to $\str{A}, \elemtuplea$ by transitivity of bisimilarity).
For an element $r \in \unraveldom{A}$, we construct the finite tree $\mathcal{T}_{r,\ell}(\unravel{A})$ as follows:
\begin{equation*}
  \mathcal{T}_{r,\ell}(\unravel{A}) = \left\{ e \in \unraveldom{A}:\, e\ \text{is a descendant of $r$ and the length of $\seq{e}$ is at most $2 * \ell$} \right\}\bbe{.}
\end{equation*}
Note that this is a tree since for elements $a$ and $b$, if $b$ is a descendant of $a$ then the length of $\seq{b}$ is never less than that of $\seq{a}$.
Recall that a bisimulation sequence of length $\ell$ is just a word in $A^*{(\N\N{}A^{*})}^{\ell}$.
If $A$ is finite, then there are only a finite number of bisimulation sequences of length $\ell$ because the indices chosen from $\N$ are bounded by the maximum size of live tuples in $\str{A}$, which is not larger than the (finite) maximum arity of any relation $\relR \in \sigma$.
Thus, the number of different bisimulation sequences of length $\ell$ for the finite structure $\str{A}$ is finite.
For a given sequence, there are only a finite number of elements in the domain of the unraveling.
Because the sequence length of elements in $\mathcal{T}_{r,\ell}$ is bounded by $2 * \ell$, it follows that $\mathcal{T}_{r, \ell}$ is finite.
Now consider the set $S$ composed of trees for roots $r$ where the length of $\seq{r}$ is at most $\ell$.
An element $b$ is called a \emph{cut element} of a tree in $S$ if it itself is not part of the tree but $(a,b) \in \relNext$ for some $a$ in the tree.
Let $M \in \mathbb{N}$ be such that each cut element of a tree in $S$ can be assigned an index from $1, \ldots, M$, which is possible since the trees in $S$ are finite.
The domain of the structure $\unravel{A}_{\ell}$ consists of $m$ copies of each tree in $S$.
The relations are defined as in $\unravel{A}$, but with the relation $\relNext$ replaced by by its finitary variant $\relNext_{\ell}$, where $(a,b) \in \relNext_{\ell}$ if:
\begin{itemize}
  \item $(a,b) \in \relNext$, or
  \item $(a,a') \in \relNext$ where $a'$ is a cut element with associated index $m$, and all of the following are true:
        \begin{enumerate}
          \item $b$ is the root of the $m$-th copy of tree in $S$,
          \item $\ctr{b} = \ctr{a'}$,
          \item $\seq{b}$ is the length-$\ell$ suffix of $\seq{a'}$.
        \end{enumerate}
\end{itemize}

\noindent
The structure $\unravel{A}_{\ell}$ is tree-like, in the sense of the following lemma:
\begin{lemma}\label{lem:companion-tree-like}
  Let $D_{a, \ell}(\unravel{A}_{\ell})$ be the set of elements $b$ for which there exists a next-chain starting from $a$ and ending in $b$ of length at most $\ell$.
  For any element $a \in \unraveldom{A}_{\ell}$, the set $D_{a, \ell}$ is a tree.
\end{lemma}
\begin{proof}
  \bfbox{write proof}
\end{proof}
Let $\unravel{A}_{\ell}$ and $\unravel{B}_{\ell}$ be finite unravelings of some $\sigma$-structures $\str{A}$ and $\str{B}$.
We employ the tree-like property of the unraveling to show that for sufficient large $\ell$, there is a partial isomorphism between any two $\sigma$-live tuples of the same size and with the same $\FGF$-type from $\unravel{A}_{\ell}$ and $\unravel{B}_{\ell}$, respectively.
Let $W$ be the maximal arity of symbols from $\sigma$.
Let $\ell > W$ and consider tuples $\elemtuptuples \sqin \unraveldom{A}_{\ell}$ and $\elemtuptuplet \sqin \unraveldom{B}_{\ell}$ with equal $\FGF$-types and equal size $k$.
We claim that the map $\mu_{(\elemtuptuples, \elemtuptuplet)}$, that maps $s_{i}$ to $t_{i}$ for all $i \in [1, k]$, is a partial isomorphism.
Let $\elemtuptupler$ be a tuple with $\elemtuptupler \sqin \set(\elemtuptuples)$ and $\elemtuptupler \in \relR^{\str{A}}$ for some relation $\relR \in \sigma$.
We first show that $\elemtuptupler$ is an infix of $\elemtuptuples$.
Suppose to the contrary that $\elemtuptupler$ is not an infix of $\elemtuptuples$, thus there is an $i$ such that $r_{i} = s_{v}$ and $r_{i+1} = s_{w}$ with $v \ne w - 1$.
But then both $(s_{v}, s_{w}) \in \relNext_{\ell}$ and $(s_{w-1}, s_{w}) \in \relNext_{\ell}$ since $\elemtuptupler$ and $\elemtuptuples$ are $\sigma$-live.
This is a contradiction, since $D_{s_{1}, W}$ defined in \cref{lem:companion-tree-like} includes $s_{v}, s_{w-1}$ and $s_{w}$ but cannot be a tree since $s_{w}$ would have two parents $s_{v}$ and $s_{w-1}$.
Therefore, $\elemtuptupler$ is an infix of $\elemtuptuples$.
It follows from equality of $\FGF$-types that $\mu_{(\elemtuptuples, \elemtuptuplet)}[\elemtuptupler] \in \relR^{\str{B}}$.
Since the argument is symmetric, we conclude that elements of $\elemtuptuples$ and $\elemtuptuplet$ satisfy the same relations and so $\mu_{(\elemtuptuples, \elemtuptuplet)}$ is a partial isomorphism.

Next, we describe a symmetric relation ``$\approx_{z}$'' between elements of $\unravel{A}_{\ell}$ and $\unravel{B}_{\ell}$, with these properties: \bbe{include some intuitions first... }

\bbebox{stopped here.}

\begin{description}
  \item[\desclabel{(harmony)}{elemeq:harmony}] If $e_{i} \approx_{z} f_{i}$ for all indices $i$ of live tuples $\elemtuptuplee$ and $\elemtuptuplef$ of equal size, then $\elemtuptuplee$ and $\elemtuptuplef$ have the same $\FGF$-type.
  \item[\desclabel{(global)}{elemeq:global}] If $\str{A} \bisimto_{\FGF}^{2*z + 1} \str{B}$, then for any $e \in \unraveldom{A}_{\ell}$, there is $f \in \unraveldom{B}_{\ell}$ such that $e \approx_{z} f$.
  \item[\desclabel{(succ)}{elemeq:succ}] For $1 \le z$ and $z \le \ell$, if $(e, e') \in \relNext_{\ell}$ and $e \approx_{z} f$, then there is $f'$ with $e' \approx_{z-1} f'$ and $(f, f') \in \relNext_{\ell}$.
  \item[\desclabel{(pred)}{elemeq:pred}] For $1 \le z$ and $z \le \ell$, if $(e, e') \in \relNext_{\ell}$ and $e' \approx_{z} f'$, then there is $f$ with $e \approx_{z-1} f$ and $(f, f') \in \relNext_{\ell}$.
\end{description}
We define $\approx_{z}$ as follows: for elements $e \in \unraveldom{A}_{\ell}$ and $f \in \unraveldom{B}_{\ell}$ with $\seq{e} = \elemtuples^{(0)}\cdots(i^{(n)}, j^{(n)})\elemtuples^{(n)}$ and $\seq{f} = \elemtuplet^{(0)}\cdots(v^{(m)}, w^{(m)})\elemtuplet^{(m)}$, let $e \approx_{z} f$ if and only if:
\begin{enumerate}
  \item $\ctr{e} = \ctr{f}$
  \item $i^{(n-x)} = v^{(m-x)} \wedge j^{(n-x)} = w^{(m-x)}$ for $x \le z$ (last $z$ indices are equal)
  \item $\elemtuples^{(n-x)} \bisimto_{\FGF}^{z} \elemtuplet^{(m-x)}$ for $x \le z$ (last $z$ tuples are $z$-$\FGF$-bisimilar)
\end{enumerate}
\begin{proof}
We show that $\approx_{z}$ obeys all of the properties:

\noindent
\textbf{\ref{elemeq:harmony}}
Let $\elemtuptuplee = (e_{1}, \ldots, e_{n})$ and $\elemtuptuplef = (f_{1}, \ldots, f_{n})$.
Let $\elemtuples$ and $\elemtuplet$ be the tuples of $\str{A}$ and $\str{B}$ such that $\seq{e_{n}} = \cdots \elemtuples$ and $\seq{f_{n}} = \cdots \elemtuplet$.
Since $\elemtuplee \approx_z \elemtuplef$, we know that $\elemtuples \bisimto_{\FGF}^{z} \elemtuplet$ which in particular means that $\elemtuples$ and $\elemtuplet$ have the same $\FGF$-type.
By the properties of $\relNext$, we also know that $\pi[\elemtuplee] = \elemtuples_{\ctr{e_{n}}-n\ldots{}\ctr{e_{n}}}$ and $\pi[\elemtuplet] = \elemtuplet_{\ctr{f_{n}}-n\ldots{}\ctr{f_{n}}}$.
As $\ctr{e_{n}} = \ctr{f_{n}}$, both $\elemtuptuplee$ and $\elemtuptupleb$ project to infixes of $\elemtuples_{i\ldots{}j}$ and $\elemtuplet_{i\ldots{}j}$ over the common range $i = \ctr{e_{n}} - n$ and $j = \ctr{e_{n}}$.
Hence, $\FGF$-types of $\pi[\elemtuptuplee]$ and $\pi[\elemtuptuplef]$ are also equal.
Now consider an infix $\elemtuptuplee_{i\ldots{}j}$ and the corresponding infix $\elemtuptuplef_{i\ldots{}j}$.
We show that the three conditions of the definition of relations in the unraveling are satisfied for $\elemtuptuplee_{i\ldots{}j}$ exactly if they are satified for $\elemtuptuplef_{i\ldots{}j}$:
\begin{enumerate}
  \item $\pi[\elemtuptuplee_{i\ldots{}j}] \in \relR^{\str{A}}$ if and only if $\pi[\elemtuptuplef_{i\ldots{}j}] \in \relR^{\str{B}}$, because $\pi[\elemtuptuplee]$ and $\pi[\elemtuptuplef]$ have equal $\FGF$-types,
  \item $\elemtuptuplee_{i\ldots{}j}$ is a next-chain if and only if $\elemtuptuplef_{i\ldots{}j}$ is a next-chain, because both infixes are always next-chains since $\elemtuptuplee$ and $\elemtuptuplef$ are next-chains,
  \item $|\elemtuptuplee_{i\ldots{}j}| \le \mathtt{bound}(\elemtuptuplee_{i\ldots{}j})$ if and only if $|\elemtuptuplef_{i\ldots{}j}| \le \mathtt{bound}(\elemtuptuplef_{i\ldots{}j})$ because both infixes are of length $j-i+1$, and $\mathtt{bound}$ is equal since the precondition $e_{j} \approx_{z} f_{j}$ implies $\ctr{e_{j}} = \ctr{f_{j}}$.
\end{enumerate}
Therefore, infixes of $\elemtuptuplee$ and $\elemtuptuplef$ realize the same relations.
We conclude that $\elemtuptuplee$ and $\elemtuptuplef$ have equal $\FGF$-types.

\noindent
\textbf{\ref{elemeq:global}}
Let $e \in \unraveldom{A}_{\ell}$ with $\seq{e} = \elemtuples^{(0)}\cdots{}(i^{(n)}, j^{(n)})\elemtuples^{(n)}$.
Let $\bisimZ_{0}, \ldots, \bisimZ_{2*z + 1}$ be the bisimulation between $\str{A}$ and $\str{B}$.
Let $m$ be the smaller of $z$ and $n$.
Using~\ref{bisim:fforth} $m$ times, we obtain live tuples $\elemtuplet^{(0)}, \ldots, \elemtuplet^{(m)}$ with $(\elemtuples^{(n-m)}, \elemtuplet^{(0)}) \in \bisimZ_{2*z}, \ldots, (\elemtuples^{(n)}, \elemtuplet^{(m)}) \in \bisimZ_{2*z - m}$ such that $\elemtuplet^{(0)}(i^{(n-m+1)}, j^{(n-m+1)})\elemtuplet^{(1)}\cdots{}\elemtuplet^{(m)}$ is a bisimulation sequence.
For any bisimulation it holds that $\bisimZ_{0} \supseteq \bisimZ_{1} \supseteq \cdots{} \supseteq \bisimZ_{2*z+1}$, thus
$(\elemtuples^{(n-m+x)}, \elemtuplet^{(x)}) \in \bisimZ_{2*z - m}$ for all $x$.
Hence, since $z \le 2*z - m$, the tuples $\elemtuples^{(n-m+x)}$ and $\elemtuplet^{(x)}$ are $z$-$\FGF$-bisimilar for any $x$.
We let $f$ be the element of $\unraveldom{B}_{\ell}$ with $\seq{f} = \elemtuplet^{(0)}(i^{(n-m+1)}, j^{(n-m+1)})\elemtuplet^{(1)}\cdots{}\elemtuplet^{(m)}$ and $\ctr{f} = \ctr{e}$.
This satisfies $e \approx_{z} f$ as required.

\noindent
\textbf{\ref{elemeq:succ}}
Let $(e, e') \in \relNext_{\ell}$ and $e \approx_{z} f$ for some $f \in \unraveldom{B}_{\ell}$.
We proceed by case analysis on the definition of $\relNext_{\ell}$.
The~\ref{next:addctr}~case has $\seq{e'} = \seq{e}$ and $\ctr{e'} = \ctr{e} + 1$.
We set $f'$ such that $\seq{f'} = \seq{f}$ and $\ctr{f'} = \ctr{f} + 1$, so clearly $(f, f') \in \relNext_{\ell}$.
Additionally, if $e \approx_{z} f$, then also $e' \approx_{z} f'$, which implies $e' \approx_{z-1} f'$ as wanted.
In the~\ref{next:addseq}~case, the sequence $\seq{e'}$ is equal to $\seq{e} (i, j) \elemtuples$ or the $\ell$-length suffix of that sequence.
Let $\elemtupleo$ and $\elemtuplep$ be tuples such that $\seq{e} = \cdots \elemtupleo$ and $\seq{f} = \cdots \elemtuplep$.
By $e \approx_{z} f$, we know that $\elemtupleo \bisimto_{\FGF}^{z} \elemtuplep$.
It follows from the laws of forward guarded bisimulation that there is a tuple $\elemtuplet$ such that $\elemtuples \bisimto_{\FGF}^{z-1} \elemtuplet$ and $\seq{f} (i,j) \elemtuplet$ is a bisimulation sequence.
Let $\seq{f'}$ be equal to $\seq{f} (i,j) \elemtuplet$ or if that sequence is longer than $2 * \ell$, to the length-$\ell$ suffix of that sequence.
Let $\ctr{f'} = (j-i+1) + 1$, which is equal to $\ctr{e'}$.
By construction $(f, f') \in \relNext_{\ell}$.
Next, we show that $f \approx_{z-1} f'$.
First, consider the length of $\seq{e'}$ and $\seq{f'}$.
We need to show that if either sequence has length less than $z-1$, then the other sequence has the same length.
So suppose that one of the sequences is shorter than $z-1$.
Since $z - 1 < \ell$, this is only possible if $\seq{e}$ or $\seq{f}$ is shorter than $z-1$.
Since $e \approx_{z} f$, the length of $\seq{e}$ must be equal to $\seq{f}$ in this case.
But then both $\seq{e} (i,j) \elemtuples$ and $\seq{f} (i,j) \elemtuplet$ have equal lengths shorter than $2 * \ell$, so the lengths of $\seq{e'}$ and $\seq{f'}$ are equal.
Finally, observe that the conditions for $e' \approx_{z-1} f'$ all carry over from $e \approx_{z} f$, except for the last step of the sequence in $\seq{e'}$ and $\seq{f'}$.
But we chose $\elemtuplet$ such that $\elemtuples \bisimto_{\FGF}^{z-1} \elemtuplet$, so the conditions also hold for the last step.
Therefore $e' \approx_{z-1} f'$ as required.

\noindent
\textbf{\ref{elemeq:pred}}
Let $(e, e') \in \relNext_{\ell}$ and $e' \approx_{z} f'$ for some $f' \in \unraveldom{B}_{\ell}$.
If $\seq{e'} = \seq{e}$, then $\ctr{e} = \ctr{e'} - 1$ and we can set $f = (\seq{f'}, \ctr{f} - 1)$ which has the required properties.
Otherwise, $\seq{e'} = \sigma (i,j) \elemtuples$ where $\sigma$ is equal to either $\seq{e}$ or the length $\ell-1$ suffix of $\seq{e}$.
Since $e' \approx_{z} f'$, first $\ctr{e'} = \ctr{f'} = (j-i+1) + 1$ and second there must be a tuple $\elemtuplet$ and a sequence $\theta$ such that $\seq{f'} = \theta (i,j) \elemtuplet$.
With $f = (\theta, j)$, we have $(f, f') \in \relNext_{\ell}$ and $(\sigma, j) \approx_{z-1} f$.
If $\sigma$ is not equal to $\seq{e}$, it is of length $\ell-1$ so it still contains the last $z-1$ elements of $\seq{e}$ since $z \le \ell$.
Therefore, the required property $e \approx_{z-1} f$ follows from $(\sigma, j) \approx_{z-1} f$.
\end{proof}

We claim that the following sequence of sets $\bisimZ_{0}, \ldots, \bisimZ_{\ell} \subseteq \PartIso{\unravel{A}_{W * \ell}}{\unravel{B}_{W * \ell}}$ is a $\ell$-$\GF$-bisimulation:
\begin{equation*}
  \bisimZ_{k} = \left\{
    \mu_{(\elemtuptuples, \elemtuptuplet)}:\,
    \elemtuptuples\ \text{and}\ \elemtuptuplet\ \text{are live and}\ \
    s_{i} \approx_{W * k} t_{i}\ \text{for all indices $i$}
  \right\}
\end{equation*}
\begin{proof}
\end{proof}
